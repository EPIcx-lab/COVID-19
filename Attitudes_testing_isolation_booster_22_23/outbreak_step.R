# run one generation of infection
library(magrittr)

#' @param num.initial.cases number of individuals in the 0th generation
#' @param prop.asym proportion of asymptomatic individuals in the unvaccinated subpopulation
#' @param prob_vacc proportion of vaccinated individuals in the branching process 
#' @param delayfn_ parameters of the distribution of behvioral delays
#' @param inf_ parameters of the distribution of generation times
#' @param incfn parameters of the distribution of incubation periods
#' @param incfn_vaccinated
#' @param quarantine parameter that is not used
#' @param disp. dispersion parameters of the distribution of the number of secondary cases
#' @param r0subclin.vaccinated mean number of secondary cases generated by an asymptomatic vaccinated individual
#' @param r0subclin mean number of secondary cases generated by an asymptomatic unvaccianted case
#' @param r0community.vaccinated mean number of secondary cases generated by a symptomatic vaccinated individual
#' @param r0community mean number of secondary cases generated by a symptomatic unvaccinated case
#' @param prop.ascertain probability that an offspring will be traced by its infector if the infector traces its contacts
#' @param test_delay_antigenic delay between test sampling and test result for antigenic tests
#' @param scenario which protocol
#' @param awareness probability that an individual tests a second time if negative but symptomatic
#' @param number_daily_tests maximum number of daily performed tests for individuals who are negative and symptomatic
#' @param comply probability of repeating a test more than twice if negative but symptomatic
#' @param test_compliance_sympt compliance to getting tested if recommended to do so by health authorities, if symptomatic
#' @param test_compliance_asymptcompliance to getting tested if recommended to do so by health authorities, if asymptomatic
#' @param probability_full_iso_sympt compliance to isolation if symptomatic and if recommended by authorities to do so
#' @param probability_full_iso_asympt compliance to isolation if asymptomatic and if recommended by authorities to do so

outbreak_step <- function( case_data = NULL,
                           
                           prop.asym = NULL,
                           prop.ascertain = NULL,
                           prob_vacc = NULL,
                           
                           incfn = NULL,
                           incfn_vaccinated = NULL,
                           
                           delayfn = NULL,
                           delayfn_sympt = NULL,
                           delayfn_subclin = NULL,
                           delayfn_vaccinated_subclin = NULL,
                           delayfn_vaccinated_sympt = NULL,
                           delay_shape_vaccinated_sympt = NULL,
                           delay_shape_sympt = NULL,
                           delay_shape_vaccinated_subclin = NULL,
                           delay_shape_subclin = NULL,
                           
                           r0isolated = NULL,
                           disp.iso = NULL,
                           disp.iso.vaccinated = NULL,
                           r0community = NULL,
                           r0community.vaccinated = NULL,
                           disp.com = NULL,
                           disp.com.vaccinated = NULL,
                           r0subclin = NULL,
                           r0subclin.vaccinated = NULL,
                           disp.subclin = NULL,
                           disp.subclin.vaccinated = NULL,
                           
                           inf_shape = NULL,
                           inf_rate = NULL,
                           inf_shift = NULL,
                           inf_shape_vaccinated = NULL,
                           inf_rate_vaccinated = NULL,
                           inf_shift_vaccinated = NULL,
                           
                           quarantine = NULL,
                           test_delay_antigenic = NULL,
                           scenario = NULL,
                           awareness = NULL,
                           number_daily_tests = NULL,
                           comply = NULL,
                           test_compliance_sympt = NULL,
                           test_compliance_asympt = NULL,
                           probability_full_iso_sympt = NULL,
                           probability_full_iso_asympt = NULL
) {

  household_prob <- r0isolated
  
  # A vectorised version of isTRUE
  vect_isTRUE <- function(x) {
    purrr::map_lgl(x, isTRUE)
  }
  vect_max <- function(x, y) {
    purrr::map2_dbl(x, y, max)
  }
  vect_min <- function(x, y) {
    purrr::map2_dbl(x, y, min)
  }

  new_case_data <- case_data[new_cases > 0 & vect_isTRUE(!removed)]
  total_new_cases <- new_case_data[, sum(new_cases), ]
  # If no new cases are drawn, the outbreak is over, so return case_data
  if (total_new_cases == 0) {
    case_data$removed <- TRUE
    
    effective_r0 <- 0
    cases_in_gen <- 0
    new_case_0 <- rep(0, nrow(case_data))
    
    timeexp <- case_data$timeexp
    number_tests <- NA
    mean_iso_duration <- NA
    infector_iso_exit <- NA
    infector_iso_time <- NA
    number_isolating <- NA
    number_traced_asym_iso <- NA
    number_sympt_iso <- NA 
    number_sympt_iso <- NA
    t_1 <- NA
    t_2 <- NA
    individual_tests <- NA
    b <- 0

    out <- list(case_data, effective_r0, cases_in_gen, new_case_0, timeexp, number_tests, mean_iso_duration, infector_iso_time, infector_iso_exit, number_isolating, number_traced_asym_iso, number_sympt_iso, number_sympt_iso, t_1, t_2, individual_tests, b)
    names(out) <- c("cases", "effective_r0", "cases_in_gen", "new_cases_ind", "timeexp", "number_tests", "mean_iso_duration", "infector_iso_time", "infector_iso_exit", "number_isolating", "number_traced_asym_iso", "number_sympt_iso", "number_sympt_iso", "t_1", "t_2", "individual_tests", "b")
    
    return(out)
  }
  
  # prob_samples is the case_data table for the new generation (to be appended to the previous generation table, as an output of the branching process)
  prob_samples <- data.table(
    # records the absolute time of exposure of infectors
    infector_timeexp = unlist(purrr::map2(new_case_data$timeexp, new_case_data$new_cases,
                                          function(x, y) {
                                            rep(x, as.integer(y))
                                          })),
    # records whether infector had a positive test
    infector_pos = unlist(purrr::map2(new_case_data$first_pos, new_case_data$new_cases, 
                                      function(x, y) {
                                        rep(x, y)
                                      })),
    # records the id of the infector of each newly infected person
    infector = unlist(purrr::map2(new_case_data$caseid, new_case_data$new_cases,
                                  function(x, y) {
                                    rep(as.integer(x), as.integer(y))
                                  })),
    # records the time at which the infector of each newly infected person entered isolation
    infector_iso_time = unlist(purrr::map2(new_case_data$isolated_time, new_case_data$new_cases,
                                           function(x, y) {
                                             rep(x, as.integer(y))
                                           })),
    # records the time of positive test of the infector (for tracing) of each newly infected person
    time_inf_pos = unlist(purrr::map2(new_case_data$time_first_test, new_case_data$new_cases,
                                      function(x, y) {
                                        rep(x, as.integer(y))
                                      })),
    # records the time of exit from isolation of the infector of each newly infected person
    infector_iso_exit = unlist(purrr::map2(new_case_data$isolated_exit_time, new_case_data$new_cases,
                                           function(x, y) {
                                             rep(x, as.integer(y))
                                           })),
    # records whether the infector of each newly infected person was missed by the CT system or not
    infector_missed = unlist(purrr::map2(new_case_data$missed, new_case_data$new_cases,
                                         function(x, y) {
                                           rep(x, as.integer(y))
                                         })),
    # records whether the infector of each newly infected person is asymptomatic or not
    infector_asym = unlist(purrr::map2(new_case_data$asym, new_case_data$new_cases,
                                       function(x, y) {
                                         rep(x, y)
                                       })),
    missed = purrr::rbernoulli(n = total_new_cases, p = 1 - prop.ascertain), # newly infected person is missed or not
    vaccinated = purrr::rbernoulli(total_new_cases, prob_vacc), # newly infected person is vaccinated or not
    isolated = TRUE, 
    new_cases = NA, # how many secondary infections are generated by each newly infected person 
    removed = FALSE, # whether an individual is removed from the branching tree, as a consequence of not being infectious (at all or anymore)
    exposure = NA, # moment of exposure (since exposure of the infector)
    onset = NA, # moment of symptom onset (since one's exposure)
    times_infection = NA # moments of exposure of its secondary cases
  )
  
  infectors <- unique(prob_samples$infector)
  for (i in 1:length(infectors)){
    name_infector <- infectors[i]
    times_infected_by_infector <- case_data$times_infection[name_infector]
    prob_samples$exposure[prob_samples$infector == name_infector] <- unlist(times_infected_by_infector)
  }

  # removing vaccinated immune individuals
  total_new_vaccinated <- nrow(prob_samples[vaccinated == TRUE])
  prob_samples <- prob_samples[, immune := ifelse(vect_isTRUE(vaccinated), purrr::rbernoulli(total_new_vaccinated, as.numeric(prob_immune(nrow(prob_samples[vect_isTRUE(vaccinated)]))[[1]])), FALSE)]
  new_vaccinated_dontkeep <- nrow(prob_samples[immune == TRUE])
  prob_samples <- prob_samples[immune == FALSE] # only keep the vaccinated individuals that are not immune
  prob_samples <- prob_samples[, immune := NULL]
  
  # update total_new_vaccinated and total_new_cases
  total_new_vaccinated <- total_new_vaccinated - new_vaccinated_dontkeep
  total_new_cases <- total_new_cases - new_vaccinated_dontkeep
  
  prob_samples <- prob_samples[, asym := purrr::rbernoulli(n = total_new_cases, p = ifelse(vect_isTRUE(vaccinated),
                                                                                           as.numeric(prop.asym.vaccinated(nrow(prob_samples[vect_isTRUE(vaccinated)]), prop.asym)[[1]]),
                                                                                           prop.asym))]
  
  # if all new individuals are immune it is equivalent to not having any individual in the present generation
  if (total_new_cases == 0) { 
    case_data$removed <- TRUE
    
    effective_r0 <- 0
    cases_in_gen <- 0
    new_case_0 <- rep(0, nrow(case_data))
    
    timeexp <- case_data$timeexp
    number_tests <- NA
    mean_iso_duration <- NA
    infector_iso_exit <- NA
    infector_iso_time <- NA
    number_isolating <- NA
    number_traced_asym_iso <- NA
    number_sympt_iso <- NA 
    number_sympt_iso <- NA
    t_1 <- NA
    t_2 <- NA
    individual_tests <- NA
    b <- 0

    out <- list(case_data, effective_r0, cases_in_gen, new_case_0, timeexp, number_tests, mean_iso_duration, infector_iso_time, infector_iso_exit, number_isolating, number_traced_asym_iso, number_sympt_iso, number_sympt_iso, t_1, t_2, individual_tests, b)
    names(out) <- c("cases", "effective_r0", "cases_in_gen", "new_cases_ind", "timeexp", "number_tests", "mean_iso_duration", "infector_iso_time", "infector_iso_exit", "number_isolating", "number_traced_asym_iso", "number_sympt_iso", "number_vacc_iso", "individual_tests", "b")
    
    return(out)
  }

  # determine the moments of symptom onset of the newly infected individuals
  inc_samples <- incfn(total_new_cases - total_new_vaccinated)
  inc_samples_vaccinated <- incfn_vaccinated(total_new_vaccinated)
  prob_samples$onset[vect_isTRUE(prob_samples$vaccinated)] <- inc_samples_vaccinated
  prob_samples$onset[!vect_isTRUE(prob_samples$vaccinated)] <- inc_samples
  
  # determine whether newly infected individuals are missed by the contact tracing system or not based on whether the infector was asymptomatic, positive and generated offspring before or after tracing its contacts
  prob_samples$missed[vect_isTRUE(prob_samples$infector_asym)] <- TRUE
  prob_samples$missed[prob_samples$exposure>prob_samples$time_inf_pos] <- TRUE
  prob_samples$missed[!vect_isTRUE(prob_samples$infector_pos)] <- TRUE

  # draw new cases from the distributions of numbers of secondary cases for the next generation - useful in the present generation for the test sensitivity (for which the times of first and last infection events are needed)
  temporary <- purrr::map2_dbl(
    ifelse(vect_isTRUE(prob_samples$vaccinated),
           ifelse(vect_isTRUE(prob_samples$asym),
                  disp.subclin.vaccinated,
                  disp.com.vaccinated),
           ifelse(vect_isTRUE(prob_samples$asym),
                  disp.subclin,
                  disp.com)),
    
    ifelse(vect_isTRUE(prob_samples$vaccinated),
           ifelse(vect_isTRUE(prob_samples$asym),
                  r0subclin.vaccinated,
                  r0community.vaccinated),
           ifelse(vect_isTRUE(prob_samples$asym),
                  r0subclin,
                  r0community)),
    ~ rnbinom(1, size = .x, mu = .y)) 

  prob_samples$new_cases <- temporary
  
  prob_samples$times_infection[vect_isTRUE(prob_samples$vaccinated)] <- inf_fn(prob_samples$new_cases[vect_isTRUE(prob_samples$vaccinated)], inf_shape_vaccinated, inf_rate_vaccinated, inf_shift_vaccinated)
  prob_samples$times_infection[!vect_isTRUE(prob_samples$vaccinated)] <- inf_fn(prob_samples$new_cases[vect_isTRUE(!prob_samples$vaccinated)], inf_shape, inf_rate, inf_shift)
  
  # define the times of first an last infection events, t_1 and t_2 respectively
  prob_samples <- prob_samples[, t_1 := NA]
  prob_samples <- prob_samples[, t_2 := NA]
  nn <- 4 # artificial number of offspring for individuals who do not generate secondary cases
  schrom_sensitivity <- 0.98 # maximum test sensitivity
  for (i in 1:nrow(prob_samples)){
    if(!is.na(prob_samples$times_infection[i]) & length(prob_samples$times_infection[i]) >= nn){
      prob_samples$t_1[i] <- min(prob_samples$times_infection)
      prob_samples$t_2[i] <- max(prob_samples$times_infection)
    }
    if(length(prob_samples$times_infection[i]) < nn | is.na(prob_samples$times_infection[i])){
      if (length(prob_samples$times_infection[i]) < 1 | is.na(prob_samples$times_infection[i])){
        aux <- inf_fn(nn, 
                      inf_shape, 
                      inf_rate, 
                      inf_shift)
      } else {
        aux <- inf_fn(nn - length(prob_samples$times_infection[i]), 
                      inf_shape, 
                      inf_rate, 
                      inf_shift)
        aux <- c(prob_samples$times_infection[i], aux)
      }
      
      prob_samples$t_1[i] <- min(unlist(aux))
      prob_samples$t_2[i] <- max(unlist(aux))
    }
  }

  sensitivity_individual <- function(time, t_1, t_2){
    for(i in 1: length(time)){
      time[i] <- time[i] + prob_samples$onset[i]
    }
    
    out <- c()
    for(i in 1: length(time)){
      if(is.na(time[i])){
        out[i] <- 0
      }
      if(!is.na(time[i])){
        if (time[i] < (t_2[i]-t_1[i])/2 + t_1[i]){ ## b is the half-height position, a is the steepness
          if (t_1[i]<=1){
            if (time[i] < t_1[i]){
              out[i] <- pracma::sigmoid(time[i], a = 15, b = t_1[i])*schrom_sensitivity
            }
            if (time[i] >= t_1[i] & (time[i] < (t_2[i]-t_1[i])/2 + t_1[i])) {
              out[i] <- pracma::sigmoid(time[i], a = 4.7, b = t_1[i])*schrom_sensitivity
            }
          } else {
            out[i] <- pracma::sigmoid(time[i], a = 4.7, b = t_1[i])*schrom_sensitivity
          }
        }
        if (time[i] >= (t_2[i]-t_1[i])/2 + t_1[i]){
          out[i] <- pracma::sigmoid(time[i], a = -4.7, b = t_2[i])*schrom_sensitivity ## but decreasing
        }
      }
    }
    return(out)
  }

  prob_samples <- prob_samples[, adherence_sympt_traced := purrr::rbernoulli(n = total_new_cases, p = ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed),
                                                                                                             ifelse(onset > time_inf_pos - exposure,
                                                                                                                    ifelse(vect_isTRUE(vaccinated),
                                                                                                                           delay_shape_vaccinated_subclin,
                                                                                                                           delay_shape_subclin),
                                                                                                                    ifelse(vect_isTRUE(vaccinated),
                                                                                                                           delay_shape_vaccinated_sympt,
                                                                                                                           delay_shape_sympt)),
                                                                                                             NA))] 
  prob_samples <- prob_samples[, test_compliance := ifelse(prob_samples$asym==FALSE,
                                                           test_compliance_sympt,
                                                           test_compliance_asympt)]
  
  prob_samples <- prob_samples[, probability_full_iso:= ifelse(prob_samples$asym==FALSE,
                                                               probability_full_iso_sympt,
                                                               probability_full_iso_asympt)]
  
  # no TI
  if(scenario == 0){
    
    prob_samples$X <- NA
    
    prob_samples[, first_test :=  NA]
    prob_samples[, autotest1 := NA]
    prob_samples[, autotest2 := NA]
    
    test <- matrix(NA, nrow(prob_samples), number_daily_tests)
    number_awareness_tests <- 0
    prob_samples <- prob_samples[, awareness_test := NA]
    prob_samples <- prob_samples[, day_awareness_pos := NA]
    share_positive_exit_tests_belgium <- 0
    
    prob_samples[, first_pos := NA]
    prob_samples[, time_first_test := NA]
    prob_samples[, exit_test := NA]
    prob_samples[, isolated_time := NA]
    prob_samples[, isolated_exit_time := NA]
    
  }
  
  # Winter 2022 French protocol
  if(scenario == 1){
    # define the effective duration of isolation of individuals, taking into account the anticipated exit from isolation and the recommended duration of isolation of the protocol
    prob_samples$X <-  isolation_duration(nrow(prob_samples), 5, prob_samples$probability_full_iso) 
    
    # determine whether individuals get an entry test or not, and whether they test positive or not
    prob_samples[, first_test :=  ifelse(vect_isTRUE(asym),
                                         ifelse(vect_isTRUE(missed),
                                                NA,
                                                ifelse(vect_isTRUE(vaccinated),
                                                       ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                              as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure - onset, t_1, t_2))),
                                                              NA),
                                                       NA
                                                )
                                         ),
                                         ifelse(vect_isTRUE(missed),
                                                ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                       as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                       NA),
                                                ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                       ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                              as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                              NA),
                                                       ifelse(vect_isTRUE(vaccinated),
                                                              ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                     as.logical(rbinom(nrow(prob_samples), 1,sensitivity_individual(time_inf_pos - exposure - onset, t_1, t_2))),
                                                                     NA),
                                                              NA
                                                       )
                                                )
                                         )
    )
    ]
    
    # determine whether individuals test a second time for entry test (specific to the winter 2022 French protocol)
    prob_samples[, autotest1 := ifelse((vect_isTRUE(asym) & !vect_isTRUE(missed) & vect_isTRUE(vaccinated) & vect_isTRUE(!first_test)),
                                       ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                              as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure + 2 - onset, t_1, t_2))),
                                              NA),
                                       ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))) & vect_isTRUE(vaccinated) & vect_isTRUE(!first_test),
                                              ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                     as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure - onset + 2, t_1, t_2))),
                                                     NA),
                                              NA)
    )
    ]
    
    # determine whether individuals test a third time for entry test (specific to the winter 2022 French protocol)
    prob_samples[, autotest2 := ifelse((vect_isTRUE(asym) & !vect_isTRUE(missed) & vect_isTRUE(vaccinated) & vect_isTRUE(!first_test) & vect_isTRUE(!autotest1)),
                                       ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                              as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure + 4 - onset, t_1, t_2))),
                                              NA),
                                       ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))) & vect_isTRUE(vaccinated) & vect_isTRUE(!first_test) & vect_isTRUE(!autotest1),
                                              ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                     as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure - onset + 4, t_1, t_2))),
                                                     NA),
                                              NA)
    )
    ]
    
    # determine whether individuals will test daily if negative to first_test but symptomatic
    test <- matrix(FALSE, nrow(prob_samples), number_daily_tests)
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$first_test[j]) & vect_isTRUE(!prob_samples$asym[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        test[j, 1] <- as.logical(purrr::rbernoulli(n = 1, p = comply))
        for(i in 2:number_daily_tests){
          if(test[j, (i-1)] == TRUE){
            test[j, i] <- as.logical(purrr::rbernoulli(n = 1, p = awareness))
          }
        }
        for(i in 1:number_daily_tests){
          test[j, i] <- ifelse(test[j, i] == TRUE,
                               as.logical(purrr::rbernoulli(n = 1, p = sensitivity_individual(i, prob_samples$t_1, prob_samples$t_2))),
                               NA)
        }
      }
      if(!(vect_isTRUE(!prob_samples$first_test[j]) & vect_isTRUE(!prob_samples$asym[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j]))))))){
        for(i in 1:number_daily_tests){
          ifelse(test[j, i] == FALSE | is.na(test[j, i]),
                 test[j, i] <- NA,
                 NA)
        }
      }
    }
    
    i_prime <- rep(0, nrow(prob_samples))
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$first_test[j]) & vect_isTRUE(!prob_samples$asym[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        i <- 1
        i_prime[j] <- -1
        while (i <= number_daily_tests & i_prime[j] < 0){
          if(vect_isTRUE(test[j, i])){
            i_prime[j] <- i
          }
          i <- i + 1
        }
      }
    }
    
    for (j  in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$first_test[j]) & vect_isTRUE(!prob_samples$asym[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        if (i_prime[j] != -1 & i_prime[j] != number_daily_tests){
          for (i in (i_prime[j]+1):number_daily_tests){
            test[j, i] <- NA
          }
        }
      }
    }

    number_awareness_tests <- length(which(!is.na(test)))
    number_awareness_tests
    prob_samples <- prob_samples[, awareness_test := NA]
    prob_samples <- prob_samples[, day_awareness_pos := NA]
    
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$first_test[j]) & vect_isTRUE(!prob_samples$asym[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        flag <- FALSE
        day <- NA
        for (i in 1:number_daily_tests){
          if(vect_isTRUE(test[j, i])){
            flag <- TRUE
            day <- i
          }
        }
        prob_samples$awareness_test[j] <- flag
        prob_samples$day_awareness_pos[j] <- day
      }
    }
    
    # keep track of whether individuals test positive - testing positive triggers CT
    prob_samples[, first_pos := ifelse(vect_isTRUE(first_test) | vect_isTRUE(autotest1) | vect_isTRUE(autotest2) | vect_isTRUE(awareness_test),
                                       TRUE,
                                       NA)]
    
    # keep track of the time at which individiuals test positive - useful for the moment at which individiuals get traced
    prob_samples[, time_first_test := ifelse(vect_isTRUE(asym),
                                             ifelse(vect_isTRUE(missed),
                                                    NA,
                                                    ifelse(vect_isTRUE(vaccinated),
                                                           ifelse(vect_isTRUE(first_test),
                                                                  time_inf_pos - exposure,
                                                                  ifelse(vect_isTRUE(autotest1),
                                                                         time_inf_pos - exposure + 2,
                                                                         ifelse(vect_isTRUE(autotest2),
                                                                                time_inf_pos - exposure + 4,
                                                                                NA))),
                                                           NA
                                                    )
                                             ),
                                             ifelse(vect_isTRUE(missed),
                                                    ifelse(vect_isTRUE(first_test),
                                                           onset,
                                                           ifelse(vect_isTRUE(awareness_test),
                                                                  onset + day_awareness_pos,
                                                                  NA)
                                                    ),
                                                    ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                           ifelse(vect_isTRUE(first_test),
                                                                  onset,
                                                                  ifelse(vect_isTRUE(awareness_test),
                                                                         onset + day_awareness_pos,
                                                                         NA)
                                                           ),
                                                           ifelse(vect_isTRUE(vaccinated),
                                                                  ifelse(vect_isTRUE(first_test),
                                                                         time_inf_pos - exposure,
                                                                         ifelse(vect_isTRUE(autotest1),
                                                                                time_inf_pos - exposure + 2,
                                                                                ifelse(vect_isTRUE(autotest2),
                                                                                       time_inf_pos - exposure + 4,
                                                                                       NA))),
                                                                  NA
                                                           )
                                                    )
                                             )
    )]
    
    # determine whether isolating individuals test positive or negative to their exit test
    prob_samples[, exit_test := ifelse(vect_isTRUE(asym),
                                       ifelse(vect_isTRUE(missed),
                                              NA,
                                              ifelse(vect_isTRUE(vaccinated),
                                                     ifelse(vect_isTRUE(first_test),
                                                            ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure + X - onset, t_1, t_2))),
                                                                   NA),
                                                            ifelse(vect_isTRUE(autotest1),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure + 2 + X - onset, t_1, t_2))),
                                                                          NA),
                                                                   
                                                                   ifelse(vect_isTRUE(autotest2),
                                                                          ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                                 as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure + 4 + X - onset, t_1, t_2))),
                                                                                 NA),
                                                                          NA
                                                                   ))
                                                     ),
                                                     ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                            as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure + X + 2 - onset, t_1, t_2))),
                                                            NA)
                                              )
                                       ),
                                       ifelse(vect_isTRUE(missed),
                                              ifelse(vect_isTRUE(first_test),
                                                     ifelse(vect_isTRUE(vaccinated),
                                                            ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X, nrow(prob_samples)), t_1, t_2))),
                                                                   NA),
                                                            ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X + 2, nrow(prob_samples)), t_1, t_2))),
                                                                   NA)),
                                                     ifelse(vect_isTRUE(awareness_test),
                                                            ifelse(vect_isTRUE(vaccinated),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(X + prob_samples$day_awareness_pos, t_1, t_2))),
                                                                          NA),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(X + 2 + prob_samples$day_awareness_pos, t_1, t_2))),
                                                                          NA)),
                                                            NA)),
                                              ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                     ifelse(vect_isTRUE(first_test),
                                                            ifelse(vect_isTRUE(vaccinated),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X, nrow(prob_samples)), t_1, t_2))),
                                                                          NA),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X + 2, nrow(prob_samples)), t_1, t_2))),
                                                                          NA)),
                                                            ifelse(vect_isTRUE(awareness_test),
                                                                   ifelse(vect_isTRUE(vaccinated),
                                                                          ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                                 as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(X + prob_samples$day_awareness_pos, t_1, t_2))),
                                                                                 NA),
                                                                          ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                                 as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(X + 2 + prob_samples$day_awareness_pos, t_1, t_2))),
                                                                                 NA)),
                                                                   NA)),
                                                     ifelse(vect_isTRUE(vaccinated),
                                                            ifelse(vect_isTRUE(first_test),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure - onset + X, t_1, t_2))),
                                                                          NA),
                                                                   ifelse(vect_isTRUE(autotest1),
                                                                          ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                                 as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure - onset + 2 + X, t_1, t_2))),
                                                                                 NA),
                                                                          ifelse(vect_isTRUE(autotest2),
                                                                                 ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                                        as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure - onset + 4 + X, t_1, t_2))),
                                                                                        NA),
                                                                                 NA)
                                                                   )
                                                            ),
                                                            ifelse(rbinom(nrow(prob_samples), 1, 1) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(X + 2 - prob_samples$onset, t_1, t_2))),
                                                                   NA)
                                                     )
                                              )
                                       )
    )
    ]
    
    # determine the moment of entry in isolation
    prob_samples[, isolated_time := ifelse(vect_isTRUE(asym),
                                           ifelse(vect_isTRUE(missed),
                                                  Inf,
                                                  ifelse(vect_isTRUE(vaccinated),
                                                         ifelse(vect_isTRUE(first_test),
                                                                time_inf_pos - exposure + test_delay_antigenic + delayfn_vaccinated_subclin(nrow(prob_samples)),
                                                                ifelse(vect_isTRUE(autotest1),
                                                                       time_inf_pos - exposure + 2 + test_delay_antigenic + delayfn_vaccinated_subclin(nrow(prob_samples)),
                                                                       ifelse(vect_isTRUE(autotest2),
                                                                              time_inf_pos - exposure + 4 + test_delay_antigenic + delayfn_vaccinated_subclin(nrow(prob_samples)),
                                                                              Inf)
                                                                )
                                                         ),
                                                         time_inf_pos - exposure + delayfn_subclin(nrow(prob_samples))
                                                  )
                                           ),
                                           ifelse(vect_isTRUE(missed),
                                                  ifelse(vect_isTRUE(first_test),
                                                         onset + ifelse(vect_isTRUE(vaccinated),
                                                                        delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                        delayfn_sympt(nrow(prob_samples))),
                                                         ifelse(vect_isTRUE(awareness_test),
                                                                onset + day_awareness_pos + ifelse(vect_isTRUE(vaccinated),
                                                                                                   delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                   delayfn_sympt(nrow(prob_samples))),
                                                                Inf)), #Inf), ## qua!
                                                  ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                         ifelse(vect_isTRUE(first_test),
                                                                onset + ifelse(onset <  time_inf_pos - exposure,
                                                                               delayfn(nrow(prob_samples)),
                                                                               ifelse(vect_isTRUE(vaccinated),
                                                                                      delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                      delayfn_sympt(nrow(prob_samples)))),
                                                                ifelse(vect_isTRUE(awareness_test),
                                                                       onset + day_awareness_pos + ifelse(onset <  time_inf_pos - exposure,
                                                                                                          delayfn(nrow(prob_samples)),
                                                                                                          ifelse(vect_isTRUE(vaccinated),
                                                                                                                 delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                                 delayfn_sympt(nrow(prob_samples)))),
                                                                       Inf)),
                                                         ifelse(vect_isTRUE(vaccinated),
                                                                ifelse(vect_isTRUE(first_test),
                                                                       time_inf_pos - exposure + test_delay_antigenic + ifelse(onset < time_inf_pos - exposure,
                                                                                                                               ifelse(vect_isTRUE(vaccinated),
                                                                                                                                      delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                                                      delayfn_sympt(nrow(prob_samples))),
                                                                                                                               delayfn(nrow(prob_samples))
                                                                                                                               
                                                                       ),
                                                                       ifelse(vect_isTRUE(autotest1),
                                                                              time_inf_pos - exposure + 2 + test_delay_antigenic + ifelse(onset < time_inf_pos - exposure,
                                                                                                                                          ifelse(vect_isTRUE(vaccinated),
                                                                                                                                                 delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                                                                 delayfn_sympt(nrow(prob_samples))),
                                                                                                                                          delayfn(nrow(prob_samples))
                                                                                                                                          
                                                                              ),
                                                                              ifelse(vect_isTRUE(autotest2),
                                                                                     time_inf_pos - exposure + 4 + test_delay_antigenic + ifelse(onset < time_inf_pos - exposure,
                                                                                                                                                 ifelse(vect_isTRUE(vaccinated),
                                                                                                                                                        delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                                                                        delayfn_sympt(nrow(prob_samples))
                                                                                                                                                 ),
                                                                                                                                                 delayfn(nrow(prob_samples))
                                                                                                                                                 
                                                                                     ),
                                                                                     Inf)
                                                                       )
                                                                ),
                                                                time_inf_pos - exposure + ifelse(onset < time_inf_pos - exposure,
                                                                                                 ifelse(vect_isTRUE(vaccinated),
                                                                                                        delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                        delayfn_sympt(nrow(prob_samples))
                                                                                                 ),
                                                                                                 delayfn(nrow(prob_samples))
                                                                )
                                                         )
                                                  )
                                           )
    )]
    prob_samples$exit_test[prob_samples$isolated_time == Inf] <- NA
    
    # determine the moment of exit from isolation
    prob_samples[, isolated_exit_time := ifelse(vect_isTRUE(asym),
                                                ifelse(vect_isTRUE(missed),
                                                       NA,
                                                       ifelse(vect_isTRUE(vaccinated),
                                                              ifelse(vect_isTRUE(first_test),
                                                                     ifelse(vect_isTRUE(exit_test),
                                                                            vect_max(time_inf_pos - exposure + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                            vect_max(time_inf_pos - exposure + X + test_delay_antigenic, isolated_time)
                                                                     ),
                                                                     ifelse(vect_isTRUE(autotest1),
                                                                            ifelse(vect_isTRUE(exit_test),
                                                                                   vect_max(time_inf_pos - exposure + 2 + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                                   vect_max(time_inf_pos - exposure + 2 + X + test_delay_antigenic, isolated_time)
                                                                            ),
                                                                            ifelse(vect_isTRUE(autotest2),
                                                                                   ifelse(vect_isTRUE(exit_test),
                                                                                          vect_max(time_inf_pos - exposure + 4 + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                                          vect_max(time_inf_pos - exposure + 4 + X + test_delay_antigenic, isolated_time)),
                                                                                   NA)
                                                                     )
                                                              ),
                                                              ifelse(vect_isTRUE(exit_test),
                                                                     vect_max(max(X + 2 + test_delay_antigenic, X + 5), isolated_time),
                                                                     vect_max(X + 2 + test_delay_antigenic, isolated_time)
                                                              )
                                                       )
                                                ),
                                                ifelse(vect_isTRUE(missed),
                                                       ifelse(vect_isTRUE(first_test),
                                                              ifelse(vect_isTRUE(exit_test),
                                                                     ifelse(vect_isTRUE(vaccinated),
                                                                            vect_max(onset + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                            vect_max(onset + max(X + 5, X + 2 + test_delay_antigenic), isolated_time)
                                                                     ),
                                                                     ifelse(vect_isTRUE(vaccinated),
                                                                            vect_max(onset + X + test_delay_antigenic, isolated_time),
                                                                            vect_max(onset + X + 2 + test_delay_antigenic, isolated_time)
                                                                     )
                                                              ),
                                                              ifelse(vect_isTRUE(awareness_test),
                                                                     ifelse(vect_isTRUE(exit_test),
                                                                            ifelse(vect_isTRUE(vaccinated),
                                                                                   vect_max(onset + day_awareness_pos + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                                   vect_max(onset + day_awareness_pos + max(X + 5, X + 2 + test_delay_antigenic), isolated_time)
                                                                            ),
                                                                            ifelse(vect_isTRUE(vaccinated),
                                                                                   vect_max(onset + day_awareness_pos + X + test_delay_antigenic, isolated_time),
                                                                                   vect_max(onset + day_awareness_pos + X + 2 + test_delay_antigenic, isolated_time)
                                                                            )
                                                                     ),
                                                                     NA)),
                                                       ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                              ifelse(vect_isTRUE(first_test),
                                                                     ifelse(vect_isTRUE(exit_test),
                                                                            ifelse(vect_isTRUE(vaccinated),
                                                                                   vect_max(onset + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                                   vect_max(onset + max(X + 5, X + 2 + test_delay_antigenic), isolated_time)
                                                                            ),
                                                                            ifelse(vect_isTRUE(vaccinated),
                                                                                   vect_max(onset + X + test_delay_antigenic, isolated_time),
                                                                                   vect_max(onset + X + 2 + test_delay_antigenic, isolated_time)
                                                                            )
                                                                     ),
                                                                     ifelse(vect_isTRUE(awareness_test),
                                                                            ifelse(vect_isTRUE(exit_test),
                                                                                   ifelse(vect_isTRUE(vaccinated),
                                                                                          vect_max(onset + day_awareness_pos + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                                          vect_max(onset + day_awareness_pos + max(X + 5, X + 2 + test_delay_antigenic), isolated_time)
                                                                                   ),
                                                                                   ifelse(vect_isTRUE(vaccinated),
                                                                                          vect_max(onset + day_awareness_pos + X + test_delay_antigenic, isolated_time),
                                                                                          vect_max(onset + day_awareness_pos + X + 2 + test_delay_antigenic, isolated_time)
                                                                                   )
                                                                            ),
                                                                            NA)),
                                                              ifelse(vect_isTRUE(vaccinated),
                                                                     ifelse(vect_isTRUE(first_test),
                                                                            ifelse(vect_isTRUE(exit_test),
                                                                                   vect_max(time_inf_pos - exposure + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                                   vect_max(time_inf_pos - exposure + X + test_delay_antigenic, isolated_time)
                                                                            ),
                                                                            ifelse(vect_isTRUE(autotest1),
                                                                                   ifelse(vect_isTRUE(exit_test),
                                                                                          vect_max(time_inf_pos - exposure + 2 + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                                          vect_max(time_inf_pos - exposure + 2 + X + test_delay_antigenic, isolated_time)),
                                                                                   ifelse(vect_isTRUE(autotest2),
                                                                                          ifelse(vect_isTRUE(exit_test),
                                                                                                 vect_max(time_inf_pos - exposure + 4 + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                                                 vect_max(time_inf_pos - exposure + 4 + X + test_delay_antigenic, isolated_time)),
                                                                                          NA)
                                                                            )
                                                                     ),
                                                                     ifelse(vect_isTRUE(exit_test),
                                                                            vect_max(max(X + 5, X + 2 + test_delay_antigenic), isolated_time),
                                                                            vect_max(X + 2 + test_delay_antigenic, isolated_time))
                                                              )
                                                       )
                                                )
    )
    ]
    prob_samples$isolated_exit_time[prob_samples$isolated_exit_time == Inf] <- NA
  }
  
  # Spring 2022 French protocol
  if(scenario == 2){
    prob_samples$X <- isolation_duration(nrow(prob_samples), 5, prob_samples$probability_full_iso) 
    
    prob_samples[, first_test :=  ifelse(vect_isTRUE(asym),
                                         ifelse(vect_isTRUE(missed),
                                                NA,
                                                ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                       as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure - onset + 2, t_1, t_2))),
                                                       NA)
                                         ),
                                         ifelse(vect_isTRUE(missed),
                                                ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                       as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                       NA),
                                                ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                       ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                              as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                              NA),
                                                       ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                              as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure - onset + 2, t_1, t_2))),
                                                              NA)
                                                )
                                         )
    )
    ]
    
    prob_samples[, autotest1 := NA
    ]
    
    prob_samples[, autotest2 := NA
    ]
    
    test <- matrix(FALSE, nrow(prob_samples), number_daily_tests)
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        test[j, 1] <- as.logical(purrr::rbernoulli(n = 1, p = comply))
        for(i in 2:number_daily_tests){
          if(test[j, (i-1)] == TRUE){
            test[j, i] <- as.logical(purrr::rbernoulli(n = 1, p = awareness))
          }
        }
        for(i in 1:number_daily_tests){
          test[j, i] <- ifelse(test[j, i] == TRUE,
                               as.logical(purrr::rbernoulli(n = 1, p = sensitivity_individual(i, prob_samples$t_1, prob_samples$t_2))),
                               NA)
        }
      }
      if(!(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j]))))))){
        for(i in 1:number_daily_tests){
          ifelse(test[j, i]==FALSE | is.na(test[j, i]),
                 test[j, i] <- NA,
                 NA)
        }
      }
    }
    
    i_prime <- rep(0, nrow(prob_samples))
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        i <- 1
        i_prime[j] <- -1
        while (i <= number_daily_tests & i_prime[j] < 0){
          if(vect_isTRUE(test[j, i])){
            i_prime[j] <- i
          }
          i <- i + 1
        }
      }
    }
    
    for (j  in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        if (i_prime[j] != -1 & i_prime[j] != number_daily_tests){
          for (i in (i_prime[j]+1):number_daily_tests){
            test[j, i] <- NA
          }
        }
      }
    }
    number_awareness_tests <- length(which(!is.na(test)))
    
    prob_samples <- prob_samples[, awareness_test := NA]
    prob_samples <- prob_samples[, day_awareness_pos := NA]
    
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        flag <- FALSE
        day <- NA
        for (i in 1:number_daily_tests){ 
          if(vect_isTRUE(test[j, i])){
            flag <- TRUE
            day <- i
          }
        }
        prob_samples$awareness_test[j] <- flag
        prob_samples$day_awareness_pos[j] <- day
      }
    }
    
    prob_samples[, time_first_test := ifelse(vect_isTRUE(asym),
                                             ifelse(vect_isTRUE(missed),
                                                    NA,
                                                    ifelse(vect_isTRUE(first_test),
                                                           time_inf_pos - exposure + 2,
                                                           NA)
                                             ),
                                             ifelse(vect_isTRUE(missed),
                                                    ifelse(vect_isTRUE(first_test),
                                                           onset,
                                                           ifelse(vect_isTRUE(awareness_test),
                                                                  onset + day_awareness_pos,
                                                                  NA)
                                                    ),
                                                    ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                           ifelse(vect_isTRUE(first_test),
                                                                  onset,
                                                                  ifelse(vect_isTRUE(awareness_test),
                                                                         onset + day_awareness_pos,
                                                                         NA)
                                                           ),
                                                           ifelse(vect_isTRUE(first_test),
                                                                  time_inf_pos - exposure + 2,
                                                                  NA)
                                                    )
                                             )
    )]
    
    
    prob_samples[, first_pos := ifelse(vect_isTRUE(first_test) | vect_isTRUE(awareness_test),
                                       TRUE,
                                       NA)]
    
    prob_samples[, exit_test := ifelse(vect_isTRUE(asym),
                                       ifelse(vect_isTRUE(missed),
                                              NA,
                                              ifelse(vect_isTRUE(first_test),
                                                     ifelse(vect_isTRUE(vaccinated),
                                                            ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure + 2 + test_delay_antigenic + X - onset, t_1, t_2))),
                                                                   NA),
                                                            ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure + 2 + test_delay_antigenic + X + 2 - onset, t_1, t_2))),
                                                                   NA)
                                                     ),
                                                     NA
                                              )
                                       ),
                                       ifelse(vect_isTRUE(missed),
                                              ifelse(vect_isTRUE(first_test),
                                                     ifelse(vect_isTRUE(vaccinated),
                                                            ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X, nrow(prob_samples)), t_1, t_2))),
                                                                   NA),
                                                            ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X + 2, nrow(prob_samples)), t_1, t_2))),
                                                            NA)),
                                                     ifelse(vect_isTRUE(awareness_test),
                                                            ifelse(vect_isTRUE(vaccinated),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X, nrow(prob_samples)), t_1, t_2))),
                                                                          NA),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X + 2, nrow(prob_samples)), t_1, t_2))),
                                                                          NA)),
                                                            NA)),
                                              ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                     ifelse(vect_isTRUE(first_test),
                                                            ifelse(vect_isTRUE(vaccinated),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X, nrow(prob_samples)), t_1, t_2))),
                                                                          NA),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X + 2, nrow(prob_samples)), t_1, t_2))),
                                                                   NA)),
                                                            ifelse(vect_isTRUE(awareness_test),
                                                                   ifelse(vect_isTRUE(vaccinated),
                                                                          ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                                 as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X, nrow(prob_samples)), t_1, t_2))),
                                                                                 NA),
                                                                          ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                                 as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X + 2, nrow(prob_samples)), t_1, t_2))),
                                                                                 NA)),
                                                                   NA)), #NA),## qua!
                                                     ifelse(vect_isTRUE(first_test),
                                                            ifelse(vect_isTRUE(vaccinated),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure - onset + 2 + test_delay_antigenic + X, t_1, t_2))),
                                                                          NA),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(time_inf_pos - exposure - onset + 2 + test_delay_antigenic + X + 2, t_1, t_2))),
                                                                          NA)),
                                                            NA)
                                              )
                                       )
    )
    ]
    
    prob_samples[, isolated_time := ifelse(vect_isTRUE(asym),
                                           ifelse(vect_isTRUE(missed),
                                                  Inf,
                                                  ifelse(vect_isTRUE(first_test),
                                                         ifelse(vect_isTRUE(vaccinated),
                                                                time_inf_pos - exposure + 2 + test_delay_antigenic + delayfn_vaccinated_subclin(nrow(prob_samples)),
                                                                time_inf_pos - exposure + 2 + test_delay_antigenic + delayfn_subclin(nrow(prob_samples))
                                                         ),
                                                         Inf
                                                  )
                                           ),
                                           ifelse(vect_isTRUE(missed),
                                                  ifelse(vect_isTRUE(first_test),
                                                         onset + ifelse(vect_isTRUE(vaccinated),
                                                                        delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                        delayfn_sympt(nrow(prob_samples))),
                                                         ifelse(vect_isTRUE(awareness_test),
                                                                onset + day_awareness_pos + ifelse(vect_isTRUE(vaccinated),
                                                                                                   delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                   delayfn_sympt(nrow(prob_samples))),
                                                                Inf)),
                                                  ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                         ifelse(vect_isTRUE(first_test),
                                                                onset + ifelse(onset <  time_inf_pos - exposure,
                                                                               delayfn(nrow(prob_samples)),
                                                                               ifelse(vect_isTRUE(vaccinated),
                                                                                      delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                      delayfn_sympt(nrow(prob_samples)))),
                                                                ifelse(vect_isTRUE(awareness_test),
                                                                       onset + day_awareness_pos + ifelse(onset <  time_inf_pos - exposure,
                                                                                                          delayfn(nrow(prob_samples)),
                                                                                                          ifelse(vect_isTRUE(vaccinated),
                                                                                                                 delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                                 delayfn_sympt(nrow(prob_samples)))),
                                                                       Inf)),
                                                         ifelse(vect_isTRUE(first_test),
                                                                time_inf_pos - exposure + 2 + test_delay_antigenic + ifelse(onset < time_inf_pos - exposure,
                                                                                                                            ifelse(vect_isTRUE(vaccinated),
                                                                                                                                   delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                                                   delayfn_sympt(nrow(prob_samples))
                                                                                                                            ),
                                                                                                                            delayfn(nrow(prob_samples))),
                                                                Inf)
                                                  )
                                           )
    )]
    prob_samples$exit_test[prob_samples$isolated_time == Inf] <- NA
    
    prob_samples[, isolated_exit_time := ifelse(vect_isTRUE(asym),
                                                ifelse(vect_isTRUE(missed),
                                                       NA,
                                                       ifelse(vect_isTRUE(first_test),
                                                              ifelse(vect_isTRUE(vaccinated),
                                                                     ifelse(vect_isTRUE(exit_test),
                                                                            vect_max(time_inf_pos - exposure + 2 + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                            vect_max(time_inf_pos - exposure + 2 + X + test_delay_antigenic, isolated_time)
                                                                     ),
                                                                     ifelse(vect_isTRUE(exit_test),
                                                                            vect_max(time_inf_pos - exposure + 2 + max(X + 5, X + 2 + test_delay_antigenic), isolated_time),
                                                                            vect_max(time_inf_pos - exposure + 2 + X + 2 + test_delay_antigenic, isolated_time)
                                                                     )),
                                                              NA
                                                       )
                                                ),
                                                ifelse(vect_isTRUE(missed),
                                                       ifelse(vect_isTRUE(first_test),
                                                              ifelse(vect_isTRUE(exit_test),
                                                                     ifelse(vect_isTRUE(vaccinated),
                                                                            vect_max(onset + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                            vect_max(onset + max(X + 5, X + 2 + test_delay_antigenic), isolated_time)
                                                                     ),
                                                                     ifelse(vect_isTRUE(vaccinated),
                                                                            vect_max(onset + X + test_delay_antigenic, isolated_time),
                                                                            vect_max(onset + X + 2 + test_delay_antigenic, isolated_time)
                                                                     )
                                                              ),
                                                              ifelse(vect_isTRUE(awareness_test),
                                                                     ifelse(vect_isTRUE(exit_test),
                                                                            ifelse(vect_isTRUE(vaccinated),
                                                                                   vect_max(onset + day_awareness_pos + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                                   vect_max(onset + day_awareness_pos + max(X + 5, X + 2 + test_delay_antigenic), isolated_time)
                                                                            ),
                                                                            ifelse(vect_isTRUE(vaccinated),
                                                                                   vect_max(onset + day_awareness_pos + X + test_delay_antigenic, isolated_time),
                                                                                   vect_max(onset + day_awareness_pos + X + 2 + test_delay_antigenic, isolated_time)
                                                                            )
                                                                     ),
                                                                     NA)),
                                                       ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                              ifelse(vect_isTRUE(first_test),
                                                                     ifelse(vect_isTRUE(exit_test),
                                                                            ifelse(vect_isTRUE(vaccinated),
                                                                                   vect_max(onset + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                                   vect_max(onset + max(X + 5, X + 2 + test_delay_antigenic), isolated_time)
                                                                            ),
                                                                            ifelse(vect_isTRUE(vaccinated),
                                                                                   vect_max(onset + X + test_delay_antigenic, isolated_time),
                                                                                   vect_max(onset + X + 2 + test_delay_antigenic, isolated_time)
                                                                            )
                                                                     ),
                                                                     ifelse(vect_isTRUE(awareness_test),
                                                                            ifelse(vect_isTRUE(exit_test),
                                                                                   ifelse(vect_isTRUE(vaccinated),
                                                                                          vect_max(onset + day_awareness_pos + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                                          vect_max(onset + day_awareness_pos + max(X + 5, X + 2 + test_delay_antigenic), isolated_time)
                                                                                   ),
                                                                                   ifelse(vect_isTRUE(vaccinated),
                                                                                          vect_max(onset + day_awareness_pos + X + test_delay_antigenic, isolated_time),
                                                                                          vect_max(onset + day_awareness_pos + X + 2 + test_delay_antigenic, isolated_time)
                                                                                   )
                                                                            ),
                                                                            NA)),
                                                              ifelse(vect_isTRUE(first_test),
                                                                     ifelse(vect_isTRUE(vaccinated),
                                                                            ifelse(vect_isTRUE(exit_test),
                                                                                   vect_max(time_inf_pos - exposure + 2 + max(X + 2, X + test_delay_antigenic), isolated_time),
                                                                                   vect_max(time_inf_pos - exposure + 2 + X + test_delay_antigenic, isolated_time)
                                                                            ),
                                                                            ifelse(vect_isTRUE(exit_test),
                                                                                   vect_max(time_inf_pos - exposure + 2 + max(X + 5, X + 2 + test_delay_antigenic), isolated_time),
                                                                                   vect_max(time_inf_pos - exposure + 2 + X + 2 + test_delay_antigenic, isolated_time)
                                                                            )),
                                                                     NA
                                                              )
                                                       )
                                                )
    )
    ]
    prob_samples$isolated_exit_time[prob_samples$isolated_exit_time == Inf] <- NA
  } 
  
  # Winter 2022 Belgian protocol
  if(scenario == 3){
    prob_samples$X <- isolation_duration(nrow(prob_samples), 7, prob_samples$probability_full_iso)
    Y <- 1

    prob_samples[, autotest1 := NA]
    prob_samples[, autotest2 := NA]
    prob_samples[, first_test :=  ifelse(!vect_isTRUE(asym) & vect_isTRUE(missed),
                                         ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                NA),
                                         ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & ((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))),
                                                ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                       as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                       NA),
                                                ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & vect_isTRUE(vaccinated) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))),
                                                       ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                              as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                              NA),
                                                       NA)))
    ]

    test <- matrix(FALSE, nrow(prob_samples), number_daily_tests)
    for (j in 1:nrow(prob_samples)){ 
      if(vect_isTRUE(!prob_samples$first_test[j]) & vect_isTRUE(!prob_samples$asym[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        test[j, 1] <- as.logical(purrr::rbernoulli(n = 1, p = comply))
        for(i in 2:number_daily_tests){
          if(test[j, (i-1)] == TRUE){
            test[j, i] <- as.logical(purrr::rbernoulli(n = 1, p = awareness))
          }
        }
        for(i in 1:number_daily_tests){
          test[j, i] <- ifelse(test[j, i] == TRUE,
                               as.logical(purrr::rbernoulli(n = 1, p = sensitivity_individual(i, prob_samples$t_1, prob_samples$t_2))),
                               NA)
        }
      }
      if(!(vect_isTRUE(!prob_samples$first_test[j]) & vect_isTRUE(!prob_samples$asym[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j]))))))){
        for(i in 1:number_daily_tests){
          ifelse(test[j, i]==FALSE | is.na(test[j, i]),
                 test[j, i] <- NA,
                 NA)
        }
      }
    }

    i_prime <- rep(0, nrow(prob_samples))
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$first_test[j]) & vect_isTRUE(!prob_samples$asym[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        i <- 1
        i_prime[j] <- -1
        while (i <= number_daily_tests & i_prime[j] < 0){
          if(vect_isTRUE(test[j, i])){
            i_prime[j] <- i
          }
          i <- i + 1
        }
      }
    }
    
    for (j  in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$first_test[j]) & vect_isTRUE(!prob_samples$asym[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        if (i_prime[j] != -1 & i_prime[j] != number_daily_tests){
          for (i in (i_prime[j]+1):number_daily_tests){
            test[j, i] <- NA
          }
        }
      }
    }
    number_awareness_tests <- length(which(!is.na(test)))
    number_awareness_tests
    prob_samples <- prob_samples[, awareness_test := NA]
    prob_samples <- prob_samples[, day_awareness_pos := NA]

    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$first_test[j]) & vect_isTRUE(!prob_samples$asym[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        flag <- NA
        day <- NA
        for (i in 1:number_daily_tests){
          if(vect_isTRUE(test[j, i])){
            flag <- TRUE
            day <- i
          }
        }
        prob_samples$awareness_test[j] <- flag
        prob_samples$day_awareness_pos[j] <- day
      }
    }

    prob_samples[, first_pos := ifelse(vect_isTRUE(first_test) | vect_isTRUE(awareness_test),
                                       TRUE,
                                       NA)]
    
    prob_samples[, time_first_test := ifelse(!vect_isTRUE(asym) & vect_isTRUE(missed),
                                             ifelse(vect_isTRUE(first_test),
                                                    onset,
                                                    ifelse(vect_isTRUE(awareness_test),
                                                           onset + day_awareness_pos,
                                                           NA)),
                                             ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & ((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))),
                                                    ifelse(vect_isTRUE(first_test),
                                                           onset,
                                                           ifelse(vect_isTRUE(awareness_test),
                                                                  onset + day_awareness_pos,
                                                                  NA)),
                                                    ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & vect_isTRUE(vaccinated) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))),
                                                           ifelse(vect_isTRUE(first_test),
                                                                  onset,
                                                                  ifelse(vect_isTRUE(awareness_test),
                                                                         onset + day_awareness_pos,
                                                                         NA)),
                                                           NA))
    )]
    
    prob_samples[, isolated_time := ifelse(vect_isTRUE(asym),
                                           ifelse(vect_isTRUE(missed),
                                                  Inf,
                                                  ifelse(vect_isTRUE(vaccinated),
                                                         Inf,
                                                         time_inf_pos - exposure + delayfn_subclin(nrow(prob_samples)))),
                                           ifelse(vect_isTRUE(missed),
                                                  ifelse(vect_isTRUE(first_test),
                                                         onset + ifelse(vect_isTRUE(vaccinated),
                                                                        delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                        delayfn_sympt(nrow(prob_samples))),
                                                         ifelse(vect_isTRUE(awareness_test),
                                                                onset + day_awareness_pos + ifelse(vect_isTRUE(vaccinated),
                                                                                                   delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                   delayfn_sympt(nrow(prob_samples))),
                                                                Inf)),
                                                  ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                         ifelse(vect_isTRUE(first_test),
                                                                onset + ifelse(onset <  time_inf_pos - exposure,
                                                                               delayfn(nrow(prob_samples)),
                                                                               ifelse(vect_isTRUE(vaccinated),
                                                                                      delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                      delayfn_sympt(nrow(prob_samples)))),
                                                                ifelse(vect_isTRUE(awareness_test),
                                                                       onset + day_awareness_pos + ifelse(vect_isTRUE(vaccinated),
                                                                                                          delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                          delayfn_sympt(nrow(prob_samples))),
                                                                       Inf)),
                                                         ifelse(vect_isTRUE(vaccinated),
                                                                ifelse(vect_isTRUE(first_test),
                                                                       onset + delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                       ifelse(vect_isTRUE(awareness_test),
                                                                              onset + day_awareness_pos + delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                              Inf)),
                                                                time_inf_pos - exposure + ifelse(onset > time_inf_pos - exposure,
                                                                                                 delayfn_subclin(nrow(prob_samples)),
                                                                                                 delayfn_sympt(nrow(prob_samples))))
                                                  )
                                           )
    )]

    # first exit test in a series of repeated exit tests
    prob_samples[, basic_exit_test := ifelse(vect_isTRUE(asym),
                                             ifelse(vect_isTRUE(missed),
                                                    NA,
                                                    ifelse(vect_isTRUE(vaccinated),
                                                           NA,
                                                           time_inf_pos - exposure + X
                                                    )
                                             ),
                                             ifelse(vect_isTRUE(missed),
                                                    NA,
                                                    ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                           NA,
                                                           ifelse(vect_isTRUE(vaccinated),
                                                                  NA,
                                                                  time_inf_pos - exposure + X)
                                                    )
                                             )
    )
    ]
    prob_samples$basic_exit_test[prob_samples$isolated_time == Inf] <- NA

    # exit test
    max_number_tests <- floor((3 + 1)/Y - 1) 
    exit_test <- matrix(NA, nrow(prob_samples), max(max_number_tests))

    for (j in 1:nrow(prob_samples)){
      if (!is.na(prob_samples$basic_exit_test[j])){
        for(i in 1:max_number_tests){
          p <- sensitivity_individual(prob_samples$basic_exit_test[j] + (i-1)*Y - prob_samples$onset[j], prob_samples$t_1, prob_samples$t_2)
          exit_test[j, i] <- as.logical(purrr::rbernoulli(n = 1, p = p))
        }
      }
    }

    i_prime <- rep(0, nrow(prob_samples))
    for (j in 1:nrow(prob_samples)){
      i <- 1
      i_prime[j] <- -1
      while (i <= max_number_tests & i_prime[j] < 0){
        if(vect_isTRUE(!exit_test[j, i])){
          i_prime[j] <- i
        }
        i <- i + 1
      }
    }
    
    for (j in 1:nrow(prob_samples)){
      if (i_prime[j] != -1 & i_prime[j] != max_number_tests){
        for (i in (i_prime[j]+1):max_number_tests){
          exit_test[j, i] <- NA
        }
      }
    }
    number_exit_tests <- length(which(!is.na(exit_test)))
    ifelse(number_exit_tests != 0, 
           share_positive_exit_tests_belgium <- length(which(vect_isTRUE(exit_test)))/length(which(!is.na(exit_test))),
           share_positive_exit_tests_belgium <- 0
    )
    number_exit_tests
    
    prob_samples <- prob_samples[, time_exit_test := NA]
    prob_samples <- prob_samples[, exit_test := NA]
    for (j in 1:nrow(prob_samples)){
      flag <- NA
      day <- NA
      for (i in 1:max_number_tests){ 
        if(!is.na(exit_test[j, i])){
          day <- Inf
          flag <- TRUE
        }
      }
      for (i in 1:max_number_tests){ 
        if(vect_isTRUE(!exit_test[j,i])){
          flag <- FALSE
          day <- i
        }
      }
      prob_samples$exit_test[j] <- flag
      prob_samples$time_exit_test[j] <- (day-1)*Y + prob_samples$basic_exit_test[j]
    }

    prob_samples[, isolated_exit_time := ifelse(is.na(exit_test),
                                                ifelse(!is.infinite(isolated_time),
                                                  ifelse(vect_isTRUE(asym),
                                                         NA,
                                                         ifelse(vect_isTRUE(missed),
                                                                ifelse(vect_isTRUE(first_test),
                                                                       vect_max(onset + X, isolated_time),
                                                                       ifelse(vect_isTRUE(awareness_test),
                                                                              vect_max(onset + day_awareness_pos + X, isolated_time),
                                                                              NA
                                                                       )
                                                                ),
                                                                ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                                       ifelse(vect_isTRUE(first_test),
                                                                              vect_max(onset + X, isolated_time),
                                                                              ifelse(vect_isTRUE(awareness_test),
                                                                                     vect_max(onset + day_awareness_pos + X, isolated_time),
                                                                                     NA
                                                                              )
                                                                       ),
                                                                       ifelse(vect_isTRUE(vaccinated),
                                                                              ifelse(vect_isTRUE(first_test),
                                                                                     vect_max(onset + X, isolated_time),
                                                                                     ifelse(vect_isTRUE(awareness_test),
                                                                                            vect_max(onset + day_awareness_pos + X, isolated_time),
                                                                                            NA
                                                                                     )
                                                                              ),
                                                                              NA)))),
                                                  NA
                                                ),
                                                ifelse(vect_isTRUE(exit_test),
                                                       vect_max(ifelse(vect_isTRUE(asym),
                                                              ifelse(vect_isTRUE(missed),
                                                                     NA,
                                                                     ifelse(!vect_isTRUE(vaccinated),
                                                                            NA,
                                                                            time_inf_pos - exposure)
                                                              ),
                                                              ifelse(vect_isTRUE(missed),
                                                                     NA,
                                                                     ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                                            NA,
                                                                            ifelse(vect_isTRUE(vaccinated),
                                                                                   NA,
                                                                                   time_inf_pos - exposure                                                                            )
                                                                     )
                                                              )
                                                       ) + X + 3, isolated_time),
                                                       vect_max(time_exit_test + test_delay_antigenic, isolated_time)
                                                ))
    ]
    
    prob_samples$isolated_exit_time[prob_samples$isolated_exit_time == Inf] <- NA
    prob_samples[, c("basic_exit_test", "time_exit_test") := NULL]
    
  }
  
  ## Spring 2022 Belgian protocol
  if(scenario == 4){
    prob_samples$X <- isolation_duration(nrow(prob_samples), 7, prob_samples$probability_full_iso) 
    Y <- 1

    prob_samples[, first_test :=  ifelse(!vect_isTRUE(asym),
                                         ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                NA),
                                         NA)
    ]
    
    test <- matrix(FALSE, nrow(prob_samples), number_daily_tests)
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & (vect_isTRUE(!prob_samples$first_test[j]))){
        test[j, 1] <- as.logical(purrr::rbernoulli(n = 1, p = comply))
        for(i in 2:number_daily_tests){
          if(test[j, (i-1)] == TRUE){
            test[j, i] <- as.logical(purrr::rbernoulli(n = 1, p = awareness))
          }
        }
        for(i in 1:number_daily_tests){
          test[j, i] <- ifelse(test[j, i] == TRUE,
                               as.logical(purrr::rbernoulli(n = 1, p = sensitivity_individual(i, prob_samples$t_1, prob_samples$t_2))),
                               NA)
        }
      }
      if(!(vect_isTRUE(!prob_samples$asym[j]) & (vect_isTRUE(!prob_samples$first_test[j])))){ 
        for(i in 1:number_daily_tests){
          ifelse(test[j, i] == FALSE | is.na(test[j, i]),
                 test[j, i] <- NA,
                 NA)
        }
      }
    }
    
    i_prime <- rep(0, nrow(prob_samples))
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & (vect_isTRUE(!prob_samples$first_test[j]))){
        i <- 1
        i_prime[j] <- -1
        while (i <= number_daily_tests & i_prime[j] < 0){
          if(vect_isTRUE(test[j, i])){
            i_prime[j] <- i
          }
          i <- i + 1
        }
      }
    }
    
    for (j  in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & (vect_isTRUE(!prob_samples$first_test[j]))){
        if (i_prime[j] != -1 & i_prime[j] != number_daily_tests){
          for (i in (i_prime[j]+1):number_daily_tests){
            test[j, i] <- NA
          }
        }
      }
    }
    number_awareness_tests <- length(which(!is.na(test)))
    number_awareness_tests
    prob_samples <- prob_samples[, awareness_test := NA]
    prob_samples <- prob_samples[, day_awareness_pos := NA]
    
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & (vect_isTRUE(!prob_samples$first_test[j]))){
        flag <- NA 
        day <- NA
        for (i in 1:number_daily_tests){ 
          if(vect_isTRUE(test[j, i])){
            flag <- TRUE
            day <- i
          }
        }
        prob_samples$awareness_test[j] <- flag
        prob_samples$day_awareness_pos[j] <- day
      }
    }
    
    prob_samples[, first_pos := ifelse(vect_isTRUE(first_test) | vect_isTRUE(awareness_test),
                                       TRUE,
                                       NA)]
    
    prob_samples[, time_first_test := ifelse(!vect_isTRUE(asym),
                                             ifelse(vect_isTRUE(first_test),
                                                    onset,
                                                    ifelse(vect_isTRUE(awareness_test),
                                                           onset + day_awareness_pos,
                                                           NA)),
                                             NA)
    ]
    
    prob_samples[, isolated_time := ifelse(vect_isTRUE(asym),
                                           Inf,
                                           ifelse(vect_isTRUE(first_test),
                                                  onset + ifelse(vect_isTRUE(vaccinated),
                                                          delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                          delayfn_sympt(nrow(prob_samples))
                                                          ),
                                                  ifelse(vect_isTRUE(awareness_test),
                                                         onset + day_awareness_pos + ifelse(vect_isTRUE(vaccinated),
                                                                                            delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                            delayfn_sympt(nrow(prob_samples))),
                                                         Inf))
                                          )
    ]
    
    prob_samples[, basic_exit_test := NA]
    prob_samples <- prob_samples[, time_exit_test := NA]
    prob_samples <- prob_samples[, exit_test := NA]
    prob_samples <- prob_samples[, autotest1 := NA]
    prob_samples <- prob_samples[, autotest2 := NA]
    
    number_exit_tests <- length(which(!is.na(prob_samples$exit_test)))
    ifelse(number_exit_tests != 0, 
           share_positive_exit_tests_belgium <- length(which(vect_isTRUE(prob_samples$exit_test)))/length(which(!is.na(prob_samples$exit_test))),
           share_positive_exit_tests_belgium <- 0
    )
    number_awareness_tests <- number_awareness_tests 
    number_exit_tests
    
    prob_samples[, isolated_exit_time := ifelse(vect_isTRUE(asym),
                                                NA,
                                                ifelse(vect_isTRUE(first_test),
                                                       vect_max(onset + X, isolated_time),
                                                       ifelse(vect_isTRUE(awareness_test),
                                                              vect_max(onset + day_awareness_pos + X, isolated_time),
                                                              NA)
                                                ))
    ]
    
    prob_samples$isolated_exit_time[prob_samples$isolated_exit_time == Inf] <- NA
    prob_samples[, c("basic_exit_test", "time_exit_test") := NULL]
  }
  
  # Winter 2022 Italian protocol
  if(scenario == 5){
    prob_samples$X <- isolation_duration(nrow(prob_samples), 7, prob_samples$probability_full_iso)
    
    prob_samples[, first_test :=  ifelse(!vect_isTRUE(asym) & vect_isTRUE(missed),
                                         ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                NA),
                                         ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & ((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))),
                                                ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                       as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                       NA),
                                                ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))) & vect_isTRUE(vaccinated), # i removed the onset > ct condition
                                                       ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                              as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                              NA),
                                                       NA)))
    ]
    
    
    prob_samples[, autotest2 := ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))) & vect_isTRUE(vaccinated) & vect_isTRUE(!first_test),# i removed the onset > ct condition
                                       ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                              as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(5, nrow(prob_samples)), t_1, t_2))),
                                              NA),
                                       NA)
    ]
    
    test <- matrix(FALSE, nrow(prob_samples), number_daily_tests)
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        test[j, 1] <- as.logical(purrr::rbernoulli(n = 1, p = comply))
        for(i in 2:number_daily_tests){
          if(test[j, (i-1)] == TRUE){
            test[j, i] <- as.logical(purrr::rbernoulli(n = 1, p = awareness))
          }
        }
        for(i in 1:number_daily_tests){
          test[j, i] <- ifelse(test[j, i] == TRUE,
                               as.logical(purrr::rbernoulli(n = 1, p = sensitivity_individual(i, prob_samples$t_1, prob_samples$t_2))),
                               NA)
        }
      }
      if(!(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j]))))))){
        for(i in 1:number_daily_tests){
          ifelse(test[j, i]==FALSE | is.na(test[j, i]),
                 test[j, i] <- NA,
                 NA)
        }
      }
    }
    
    i_prime <- rep(0, nrow(prob_samples))
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        i <- 1
        i_prime[j] <- -1
        while (i <= number_daily_tests & i_prime[j] < 0){
          if(vect_isTRUE(test[j, i])){
            i_prime[j] <- i
          }
          i <- i + 1
        }
      }
    }
    
    for (j  in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        if (i_prime[j] != -1 & i_prime[j] != number_daily_tests){
          for (i in (i_prime[j]+1):number_daily_tests){
            test[j, i] <- NA
          }
        }
      }
    }
    number_awareness_tests <- length(which(!is.na(test) ))
    number_awareness_tests
    prob_samples <- prob_samples[, awareness_test := NA]
    prob_samples <- prob_samples[, day_awareness_pos := NA]
    
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | (vect_isTRUE(!prob_samples$missed[j]) & ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        flag <- NA
        day <- NA
        for (i in 1:number_daily_tests){ 
          if(vect_isTRUE(test[j, i])){
            flag <- TRUE
            day <- i
          }
        }
        prob_samples$awareness_test[j] <- flag
        prob_samples$day_awareness_pos[j] <- day
      }
    }
    
    prob_samples[, first_pos := ifelse(vect_isTRUE(first_test) | vect_isTRUE(autotest2) | vect_isTRUE(awareness_test),
                                       TRUE,
                                       NA)]
    
    prob_samples[, time_first_test := ifelse(!vect_isTRUE(asym) & vect_isTRUE(missed),
                                             ifelse(vect_isTRUE(first_test),
                                                    onset,
                                                    ifelse(vect_isTRUE(awareness_test),
                                                           onset + day_awareness_pos,
                                                           NA)
                                             ),
                                             ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & ((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))),
                                                    ifelse(vect_isTRUE(first_test),
                                                           onset,
                                                           ifelse(vect_isTRUE(awareness_test),
                                                                  onset + day_awareness_pos,
                                                                  NA)
                                                    ),
                                                    ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))) & vect_isTRUE(vaccinated),
                                                           ifelse(vect_isTRUE(first_test),
                                                                  onset,
                                                                  ifelse(vect_isTRUE(autotest2),
                                                                         onset + 5,
                                                                         NA)),
                                                           NA)))
    ]
    
    prob_samples[, exit_test := ifelse(vect_isTRUE(asym),
                                       ifelse(vect_isTRUE(missed),
                                              NA,
                                              ifelse(vect_isTRUE(vaccinated),
                                                     NA,
                                                     ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                            as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(X + 3 - prob_samples$onset, t_1, t_2))), 
                                                            NA)
                                              )
                                       ),
                                       ifelse(vect_isTRUE(missed),
                                              ifelse(vect_isTRUE(first_test),
                                                     ifelse(vect_isTRUE(vaccinated),
                                                            ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X, nrow(prob_samples)), t_1, t_2))),
                                                                   NA),
                                                            ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X + 3, nrow(prob_samples)), t_1, t_2))),
                                                                   NA)),
                                                     ifelse(vect_isTRUE(awareness_test),
                                                            ifelse(vect_isTRUE(vaccinated),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X, nrow(prob_samples)), t_1, t_2))),
                                                                          NA),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X + 3, nrow(prob_samples)), t_1, t_2))),
                                                                          NA)),
                                                            NA)),
                                              ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                     ifelse(vect_isTRUE(first_test),
                                                            ifelse(vect_isTRUE(vaccinated),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X, nrow(prob_samples)), t_1, t_2))),
                                                                          NA),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X + 3, nrow(prob_samples)), t_1, t_2))),
                                                                          NA)),
                                                            ifelse(vect_isTRUE(awareness_test),
                                                                   ifelse(vect_isTRUE(vaccinated),
                                                                          ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                                 as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X, nrow(prob_samples)), t_1, t_2))),
                                                                                 NA),
                                                                          ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                                 as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X + 3, nrow(prob_samples)), t_1, t_2))),
                                                                                 NA)),
                                                                   NA)),
                                                     ifelse(vect_isTRUE(vaccinated),
                                                            ifelse(vect_isTRUE(first_test),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X, nrow(prob_samples)), t_1, t_2))),
                                                                          NA),
                                                                   ifelse(vect_isTRUE(autotest2),
                                                                          ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                                 as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(5 + X, nrow(prob_samples)), t_1, t_2))),
                                                                                 NA),
                                                                          NA)),
                                                            ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(X + 3 - prob_samples$onset, t_1, t_2))),
                                                                   NA)
                                                     )
                                              )
                                       )
    )
    ]
    
    # here I borrow the notation of the other protocols, but in fact this models the second exit test
    prob_samples[, autotest1 := ifelse(vect_isTRUE(!asym) & vect_isTRUE(missed) & vect_isTRUE(vaccinated) & vect_isTRUE(exit_test),
                                       ifelse(vect_isTRUE(first_test),
                                              ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                     as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X + 7, nrow(prob_samples)), t_1, t_2))),
                                                     NA),
                                              ifelse(vect_isTRUE(awareness_test),
                                                     ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                            as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X + 7, nrow(prob_samples)), t_1, t_2))),
                                                            NA),
                                                     NA)),
                                       ifelse(vect_isTRUE(!asym) & vect_isTRUE(!missed) & ((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))) & vect_isTRUE(vaccinated) & vect_isTRUE(exit_test),
                                              ifelse(vect_isTRUE(first_test),
                                                     ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                            as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X + 7, nrow(prob_samples)), t_1, t_2))),
                                                            NA),
                                                     ifelse(vect_isTRUE(awareness_test),
                                                            ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X + 7, nrow(prob_samples)), t_1, t_2))),
                                                                   NA),
                                                            NA)),
                                              ifelse(vect_isTRUE(!asym) & vect_isTRUE(!missed) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))) & vect_isTRUE(vaccinated) & vect_isTRUE(exit_test), #  i removed the onset > ct condition: & (onset > time_inf_pos - exposure),
                                                     ifelse(vect_isTRUE(first_test),
                                                            ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X + 7, nrow(prob_samples)), t_1, t_2))),
                                                                   NA),
                                                            ifelse(vect_isTRUE(autotest2),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(5 + X + 7, nrow(prob_samples)), t_1, t_2))),
                                                                          NA),
                                                                   NA)
                                                     ),
                                                     NA)))
    ]
    prob_samples$autotest1[prob_samples$isolated_time == Inf] <- NA
    
    prob_samples[, isolated_time := ifelse(vect_isTRUE(asym),
                                           ifelse(vect_isTRUE(missed),
                                                  Inf,
                                                  ifelse(vect_isTRUE(vaccinated),
                                                         Inf,
                                                         time_inf_pos - exposure + delayfn_subclin(nrow(prob_samples))
                                                  )
                                           ),
                                           ifelse(vect_isTRUE(missed),
                                                  ifelse(vect_isTRUE(first_test),
                                                         onset + ifelse(vect_isTRUE(vaccinated),
                                                                        delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                        delayfn_sympt(nrow(prob_samples))),
                                                         ifelse(vect_isTRUE(awareness_test),
                                                                prob_samples$day_awareness_pos + onset + ifelse(vect_isTRUE(vaccinated),
                                                                                                                delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                                delayfn_sympt(nrow(prob_samples))),
                                                                NA)),
                                                  ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                         ifelse(vect_isTRUE(first_test),
                                                                onset + ifelse(onset <  time_inf_pos - exposure,
                                                                               delayfn(nrow(prob_samples)),
                                                                               ifelse(vect_isTRUE(vaccinated),
                                                                                      delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                      delayfn_sympt(nrow(prob_samples)))), 
                                                                ifelse(vect_isTRUE(awareness_test),
                                                                       prob_samples$day_awareness_pos + onset + ifelse(onset <  time_inf_pos - exposure,
                                                                                                                       delayfn(nrow(prob_samples)),
                                                                                                                       ifelse(vect_isTRUE(vaccinated),
                                                                                                                              delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                                              delayfn_sympt(nrow(prob_samples)))),
                                                                       NA)),
                                                         ifelse(vect_isTRUE(vaccinated),
                                                                onset + ifelse(vect_isTRUE(first_test),
                                                                               0,
                                                                               ifelse(vect_isTRUE(autotest2),
                                                                                      5,
                                                                                      NA)) + delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                time_inf_pos - exposure + ifelse(onset < time_inf_pos - exposure,
                                                                                                 ifelse(vect_isTRUE(vaccinated),
                                                                                                        delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                        delayfn_sympt(nrow(prob_samples))),
                                                                                                 delayfn(nrow(prob_samples))
                                                                                                 
                                                                ))
                                                  )
                                           )
    )]
    prob_samples$exit_test[prob_samples$isolated_time == Inf] <- NA
    
    prob_samples[, isolated_exit_time := ifelse(vect_isTRUE(asym),
                                                ifelse(vect_isTRUE(missed),
                                                       NA,
                                                       ifelse(vect_isTRUE(vaccinated),
                                                              NA,
                                                              ifelse(vect_isTRUE(exit_test),
                                                                     vect_max(X + 14, isolated_time),
                                                                     vect_max(X + 3 + test_delay_antigenic, isolated_time)
                                                              )
                                                       )
                                                ),
                                                ifelse(vect_isTRUE(missed),
                                                       ifelse(vect_isTRUE(exit_test),
                                                              ifelse(vect_isTRUE(vaccinated),
                                                                     ifelse(vect_isTRUE(autotest1),
                                                                            vect_max(onset + X + 14, isolated_time),
                                                                            vect_max(onset + X + 7 + test_delay_antigenic, isolated_time)
                                                                     ),
                                                                     vect_max(onset + X + 14, isolated_time)
                                                              ),
                                                              ifelse(vect_isTRUE(vaccinated),
                                                                     vect_max(onset + X + test_delay_antigenic, isolated_time),
                                                                     vect_max(onset + X + 3 + test_delay_antigenic, isolated_time)
                                                              )
                                                       ),
                                                       ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                              ifelse(vect_isTRUE(exit_test),
                                                                     ifelse(vect_isTRUE(vaccinated),
                                                                            ifelse(vect_isTRUE(autotest1),
                                                                                   vect_max(onset + X + 14, isolated_time),
                                                                                   vect_max(onset + X + 7 + test_delay_antigenic, isolated_time)
                                                                            ),
                                                                            vect_max(onset + X + 14, isolated_time)
                                                                     ),
                                                                     ifelse(vect_isTRUE(vaccinated),
                                                                            vect_max(onset + X + test_delay_antigenic, isolated_time),
                                                                            vect_max(onset + X + 3 + test_delay_antigenic, isolated_time)
                                                                     )
                                                              ),
                                                              ifelse(vect_isTRUE(vaccinated),
                                                                     ifelse(vect_isTRUE(exit_test),
                                                                            ifelse(vect_isTRUE(autotest1),
                                                                                   vect_max(onset + ifelse(vect_isTRUE(first_test),
                                                                                                           0,
                                                                                                           ifelse(vect_isTRUE(autotest2),
                                                                                                                  5,
                                                                                                                  NA)) + X + 14, isolated_time),
                                                                                   vect_max(onset + ifelse(vect_isTRUE(first_test),
                                                                                                           0,
                                                                                                           ifelse(vect_isTRUE(autotest2),
                                                                                                                  5,
                                                                                                                  NA)) + X + 7 + test_delay_antigenic, isolated_time)
                                                                            ),
                                                                            vect_max(onset + ifelse(vect_isTRUE(first_test),
                                                                                                    0,
                                                                                                    ifelse(vect_isTRUE(autotest2),
                                                                                                           5,
                                                                                                           NA)) + X + test_delay_antigenic, isolated_time)),
                                                                     ifelse(vect_isTRUE(exit_test),
                                                                            vect_max(X + 14, isolated_time),
                                                                            vect_max(X + 3 + test_delay_antigenic, isolated_time))
                                                              )
                                                       )
                                                )
    )
    ]
    prob_samples$isolated_exit_time[prob_samples$isolated_exit_time == Inf] <- NA
  } 
  
  ## Spring 2022 Italian protocol
  if(scenario == 6){
    prob_samples$X <- isolation_duration(nrow(prob_samples), 7, prob_samples$probability_full_iso)
    
    prob_samples[, first_test :=  ifelse(!vect_isTRUE(asym) & vect_isTRUE(missed),
                                         ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                NA),
                                         ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & ((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))),
                                                ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                       as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                       NA),
                                                ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))),
                                                       ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                              as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                              NA),
                                                       NA)))
    ]
    
    prob_samples[, autotest2 := ifelse(vect_isTRUE(!asym) & vect_isTRUE(!missed) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))) & vect_isTRUE(!first_test),
                                       ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                              as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(5, nrow(prob_samples)), t_1, t_2))),
                                              NA),
                                       NA)
    ]
    
    test <- matrix(FALSE, nrow(prob_samples), number_daily_tests)
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j]))))){
        test[j, 1] <- as.logical(purrr::rbernoulli(n = 1, p = comply))
        for(i in 2:number_daily_tests){
          if(test[j, (i-1)] == TRUE){
            test[j, i] <- as.logical(purrr::rbernoulli(n = 1, p = awareness))
          }
        }
        for(i in 1:number_daily_tests){
          test[j, i] <- ifelse(test[j, i] == TRUE,
                               as.logical(purrr::rbernoulli(n = 1, p = sensitivity_individual(i, prob_samples$t_1, prob_samples$t_2))),
                               NA)
        }
      }
      if(!(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        for(i in 1:number_daily_tests){
          ifelse(test[j, i]==FALSE | is.na(test[j, i]),
                 test[j, i] <- NA,
                 NA)
        }
      }
    }
    
    i_prime <- rep(0, nrow(prob_samples))
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j]))))){
        i <- 1
        i_prime[j] <- -1
        while (i <= number_daily_tests & i_prime[j] < 0){
          if(vect_isTRUE(test[j, i])){
            i_prime[j] <- i
          }
          i <- i + 1
        }
      }
    }
    
    for (j  in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j]))))){
        if (i_prime[j] != -1 & i_prime[j] != number_daily_tests){
          for (i in (i_prime[j]+1):number_daily_tests){
            test[j, i] <- NA
          }
        }
      }
    }
    number_awareness_tests <- length(which(!is.na(test) ))
    number_awareness_tests
    prob_samples <- prob_samples[, awareness_test := NA]
    prob_samples <- prob_samples[, day_awareness_pos := NA]
    
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j]))))){
        flag <- NA
        day <- NA
        for (i in 1:number_daily_tests){
          if(vect_isTRUE(test[j, i])){
            flag <- TRUE
            day <- i
          }
        }
        prob_samples$awareness_test[j] <- flag
        prob_samples$day_awareness_pos[j] <- day
      }
    }
    
    prob_samples[, first_pos := ifelse(vect_isTRUE(first_test) | vect_isTRUE(autotest2) | vect_isTRUE(awareness_test),
                                       TRUE,
                                       NA)]
    
    prob_samples[, time_first_test := ifelse(!vect_isTRUE(asym) & vect_isTRUE(missed),
                                             ifelse(vect_isTRUE(first_test),
                                                    onset,
                                                    ifelse(vect_isTRUE(awareness_test),
                                                           onset + day_awareness_pos,
                                                           NA)
                                             ),
                                             ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & ((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))),
                                                    ifelse(vect_isTRUE(first_test),
                                                           onset,
                                                           ifelse(vect_isTRUE(awareness_test),
                                                                  onset + day_awareness_pos,
                                                                  NA)
                                                    ),
                                                    ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))),
                                                           ifelse(vect_isTRUE(first_test),
                                                                  onset,
                                                                  onset + 5),
                                                           NA))
    )]
    
    prob_samples[, exit_test := ifelse(vect_isTRUE(asym),
                                       NA,
                                       ifelse(vect_isTRUE(missed),
                                              ifelse(vect_isTRUE(first_test),
                                                     ifelse(vect_isTRUE(vaccinated),
                                                            ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X, nrow(prob_samples)), t_1, t_2))),
                                                                   NA),
                                                            ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X + 3, nrow(prob_samples)), t_1, t_2))),
                                                                   NA)),
                                                     ifelse(vect_isTRUE(awareness_test),
                                                            ifelse(vect_isTRUE(vaccinated),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X, nrow(prob_samples)), t_1, t_2))),
                                                                          NA),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X + 3, nrow(prob_samples)), t_1, t_2))),
                                                                          NA)),
                                                            NA)),
                                              ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                     ifelse(vect_isTRUE(first_test),
                                                            ifelse(vect_isTRUE(vaccinated),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X, nrow(prob_samples)), t_1, t_2))),
                                                                          NA),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X + 3, nrow(prob_samples)), t_1, t_2))),
                                                                          NA)),
                                                            ifelse(vect_isTRUE(awareness_test),
                                                                   ifelse(vect_isTRUE(vaccinated),
                                                                          ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                                 as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X, nrow(prob_samples)), t_1, t_2))),
                                                                                 NA),
                                                                          ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                                 as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X + 3, nrow(prob_samples)), t_1, t_2))),
                                                                                 NA)),
                                                                   NA)),
                                                     ifelse(vect_isTRUE(first_test),
                                                            ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X, nrow(prob_samples)), t_1, t_2))),
                                                                   NA),
                                                            ifelse(vect_isTRUE(autotest2),
                                                                   ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                          as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(5 + X, nrow(prob_samples)), t_1, t_2))),
                                                                          NA),
                                                                   NA))
                                              )
                                       )
    )
    ]
    
    ## here I borrow the notation of previous protocols, but this is in fact the loop modeling the second exit test
    prob_samples[, autotest1 := ifelse(vect_isTRUE(!asym) & vect_isTRUE(missed) & vect_isTRUE(vaccinated) & vect_isTRUE(exit_test),
                                       ifelse(vect_isTRUE(first_test),
                                              ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                     as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X + 7, nrow(prob_samples)), t_1, t_2))),
                                                     NA),
                                              ifelse(vect_isTRUE(awareness_test),
                                                     ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                            as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X + 7, nrow(prob_samples)), t_1, t_2))),
                                                            NA),
                                                     NA)),
                                       ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & vect_isTRUE(vaccinated) & vect_isTRUE(exit_test) & ((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))),
                                              ifelse(vect_isTRUE(first_test),
                                                     ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                            as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X + 7, nrow(prob_samples)), t_1, t_2))),
                                                            NA),
                                                     ifelse(vect_isTRUE(awareness_test),
                                                            ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(prob_samples$day_awareness_pos + X + 7, nrow(prob_samples)), t_1, t_2))),
                                                                   NA),
                                                            NA)),
                                              ifelse(vect_isTRUE(!asym) & vect_isTRUE(!missed) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))) & vect_isTRUE(first_test) & vect_isTRUE(exit_test),
                                                     ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                            as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(X + 7, nrow(prob_samples)), t_1, t_2))),
                                                            NA),
                                                     ifelse(vect_isTRUE(!asym) & vect_isTRUE(!missed) & (onset > time_inf_pos - exposure) & vect_isTRUE(!first_test) & vect_isTRUE(autotest2) & vect_isTRUE(exit_test),
                                                            ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                                   as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(5 + X + 7, nrow(prob_samples)), t_1, t_2))),
                                                                   NA),
                                                            NA))))
    ]
    prob_samples$autotest1[prob_samples$isolated_time == Inf] <- NA
    
    prob_samples[, isolated_time := ifelse(vect_isTRUE(asym),
                                           Inf,
                                           ifelse(vect_isTRUE(missed),
                                                  ifelse(vect_isTRUE(first_test),
                                                         onset + ifelse(vect_isTRUE(vaccinated),
                                                                        delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                        delayfn_sympt(nrow(prob_samples))),
                                                         ifelse(vect_isTRUE(awareness_test),
                                                                prob_samples$day_awareness_pos + onset + ifelse(vect_isTRUE(vaccinated),
                                                                                                                delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                                delayfn_sympt(nrow(prob_samples))),
                                                                NA)),
                                                  ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                         ifelse(vect_isTRUE(first_test),
                                                                onset + ifelse(onset <  time_inf_pos - exposure,
                                                                               delayfn(nrow(prob_samples)),
                                                                               ifelse(vect_isTRUE(vaccinated),
                                                                                      delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                      delayfn_sympt(nrow(prob_samples)))),
                                                                ifelse(vect_isTRUE(awareness_test),
                                                                       prob_samples$day_awareness_pos + onset + ifelse(onset <  time_inf_pos - exposure,
                                                                                                                       delayfn(nrow(prob_samples)),
                                                                                                                       ifelse(vect_isTRUE(vaccinated),
                                                                                                                              delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                                              delayfn_sympt(nrow(prob_samples)))),
                                                                       NA)),
                                                         onset + ifelse(vect_isTRUE(first_test),
                                                                        0,
                                                                        ifelse(vect_isTRUE(autotest2),
                                                                               5,
                                                                               NA)) + delayfn_vaccinated_sympt(nrow(prob_samples))#,
                                                  )
                                           )
    )]
    prob_samples$exit_test[prob_samples$isolated_time == Inf] <- NA
    
    prob_samples[, isolated_exit_time := ifelse(vect_isTRUE(asym),
                                                Inf,
                                                ifelse(vect_isTRUE(missed),
                                                       ifelse(vect_isTRUE(exit_test),
                                                              ifelse(vect_isTRUE(vaccinated),
                                                                     ifelse(vect_isTRUE(autotest1),
                                                                            vect_max(onset + X + 14, isolated_time),
                                                                            vect_max(onset + X + 7 + test_delay_antigenic, isolated_time)
                                                                     ),
                                                                     vect_max(onset + X + 14, isolated_time)
                                                              ),
                                                              ifelse(vect_isTRUE(vaccinated),
                                                                     vect_max(onset + X + test_delay_antigenic, isolated_time),
                                                                     vect_max(onset + X + 3 + test_delay_antigenic, isolated_time)
                                                              )
                                                       ),
                                                       ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                              ifelse(vect_isTRUE(exit_test),
                                                                     ifelse(vect_isTRUE(vaccinated),
                                                                            ifelse(vect_isTRUE(autotest1),
                                                                                   vect_max(onset + X + 14, isolated_time),
                                                                                   vect_max(onset + X + 7 + test_delay_antigenic, isolated_time)
                                                                            ),
                                                                            vect_max(onset + X + 14, isolated_time)
                                                                     ),
                                                                     ifelse(vect_isTRUE(vaccinated),
                                                                            vect_max(onset + X + test_delay_antigenic, isolated_time),
                                                                            vect_max(onset + X + 3 + test_delay_antigenic, isolated_time)
                                                                     )
                                                              ),
                                                              ifelse(vect_isTRUE(exit_test),
                                                                     ifelse(vect_isTRUE(autotest1),
                                                                            vect_max(onset + ifelse(vect_isTRUE(first_test),
                                                                                                    0,
                                                                                                    ifelse(vect_isTRUE(autotest2),
                                                                                                           5,
                                                                                                           NA)) + X + 14, isolated_time),
                                                                            vect_max(onset + ifelse(vect_isTRUE(first_test),
                                                                                                    0,
                                                                                                    ifelse(vect_isTRUE(autotest2),
                                                                                                           5,
                                                                                                           NA)) + X + 7 + test_delay_antigenic, isolated_time)
                                                                     ),
                                                                     vect_max(onset + ifelse(vect_isTRUE(first_test),
                                                                                             0,
                                                                                             ifelse(vect_isTRUE(autotest2),
                                                                                                    5,
                                                                                                    NA)) + X + test_delay_antigenic, isolated_time))#,
                                                       )
                                                )
    )
    ]
    prob_samples$isolated_exit_time[prob_samples$isolated_exit_time == Inf] <- NA
  } 
  
  ## Fall 2022 Italian protocol
  if(scenario == 7){
    prob_samples$X <- isolation_duration(nrow(prob_samples), 5, prob_samples$probability_full_iso)
    
    prob_samples[, first_test :=  ifelse(!vect_isTRUE(asym) & vect_isTRUE(missed),
                                         ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                NA),
                                         ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & ((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))),
                                                ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                       as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                       NA),
                                                ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))), 
                                                       ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                                              as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(0, nrow(prob_samples)), t_1, t_2))),
                                                              NA),
                                                       NA)))
    ]
    
    prob_samples[, autotest2 := ifelse(vect_isTRUE(!asym) & vect_isTRUE(!missed) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))) & vect_isTRUE(!first_test),
                                       ifelse(rbinom(nrow(prob_samples), 1, test_compliance) == 1,
                                              as.logical(rbinom(nrow(prob_samples), 1, sensitivity_individual(rep(5, nrow(prob_samples)), t_1, t_2))),
                                              NA),
                                       NA)
    ]
    prob_samples[, autotest1 := NA]
    test <- matrix(FALSE, nrow(prob_samples), number_daily_tests)
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j]))))){
        test[j, 1] <- as.logical(purrr::rbernoulli(n = 1, p = comply))
        for(i in 2:number_daily_tests){
          if(test[j, (i-1)] == TRUE){
            test[j, i] <- as.logical(purrr::rbernoulli(n = 1, p = awareness))
          }
        }
        for(i in 1:number_daily_tests){
          test[j, i] <- ifelse(test[j, i] == TRUE,
                               as.logical(purrr::rbernoulli(n = 1, p = sensitivity_individual(i, prob_samples$t_1, prob_samples$t_2))),
                               NA)
        }
      }
      if(!(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j])))))){
        for(i in 1:number_daily_tests){
          ifelse(test[j, i]==FALSE | is.na(test[j, i]),
                 test[j, i] <- NA,
                 NA)
        }
      }
    }
    
    i_prime <- rep(0, nrow(prob_samples))
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j]))))){
        i <- 1
        i_prime[j] <- -1
        while (i <= number_daily_tests & i_prime[j] < 0){
          if(vect_isTRUE(test[j, i])){
            i_prime[j] <- i
          }
          i <- i + 1
        }
      }
    }
    
    for (j  in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j]))))){
        if (i_prime[j] != -1 & i_prime[j] != number_daily_tests){
          for (i in (i_prime[j]+1):number_daily_tests){
            test[j, i] <- NA
          }
        }
      }
    }
    number_awareness_tests <- length(which(!is.na(test) ))
    number_awareness_tests
    prob_samples <- prob_samples[, awareness_test := NA]
    prob_samples <- prob_samples[, day_awareness_pos := NA]
    
    for (j in 1:nrow(prob_samples)){
      if(vect_isTRUE(!prob_samples$asym[j]) & vect_isTRUE(!prob_samples$first_test[j]) & ((vect_isTRUE(prob_samples$missed[j])) | ((prob_samples$onset[j] < prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(prob_samples$adherence_sympt_traced[j])) | (prob_samples$onset[j] > prob_samples$time_inf_pos[j] - prob_samples$exposure[j] & vect_isTRUE(!prob_samples$adherence_sympt_traced[j]))))){
        flag <- NA
        day <- NA
        for (i in 1:number_daily_tests){ 
          if(vect_isTRUE(test[j, i])){
            flag <- TRUE
            day <- i
          }
        }
        prob_samples$awareness_test[j] <- flag
        prob_samples$day_awareness_pos[j] <- day
      }
    }
    
    prob_samples[, first_pos := ifelse(vect_isTRUE(first_test) | vect_isTRUE(autotest2) | vect_isTRUE(awareness_test),
                                       TRUE,
                                       NA)]
    
    prob_samples[, time_first_test := ifelse(!vect_isTRUE(asym) & vect_isTRUE(missed),
                                             ifelse(vect_isTRUE(first_test),
                                                    onset,
                                                    ifelse(vect_isTRUE(awareness_test),
                                                           onset + day_awareness_pos,
                                                           NA)
                                             ),
                                             ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & ((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))),
                                                    ifelse(vect_isTRUE(first_test),
                                                           onset,
                                                           ifelse(vect_isTRUE(awareness_test),
                                                                  onset + day_awareness_pos,
                                                                  NA)
                                                    ),
                                                    ifelse(!vect_isTRUE(asym) & !vect_isTRUE(missed) & !((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced))), 
                                                           ifelse(vect_isTRUE(first_test),
                                                                  onset,
                                                                  onset + 5),
                                                           NA))
    )]
    
    prob_samples[, isolated_time := ifelse(vect_isTRUE(asym),
                                           Inf,
                                           ifelse(vect_isTRUE(missed),
                                                  ifelse(vect_isTRUE(first_test),
                                                         onset + ifelse(vect_isTRUE(vaccinated),
                                                                        delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                        delayfn_sympt(nrow(prob_samples))),
                                                         ifelse(vect_isTRUE(awareness_test),
                                                                prob_samples$day_awareness_pos + onset + ifelse(vect_isTRUE(vaccinated),
                                                                                                                delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                                delayfn_sympt(nrow(prob_samples))),
                                                                Inf)),
                                                  ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                         ifelse(vect_isTRUE(first_test),
                                                                onset + ifelse(onset <  time_inf_pos - exposure,
                                                                               delayfn(nrow(prob_samples)),
                                                                               ifelse(vect_isTRUE(vaccinated),
                                                                                      delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                      delayfn_sympt(nrow(prob_samples)))),
                                                                ifelse(vect_isTRUE(awareness_test),
                                                                       prob_samples$day_awareness_pos + onset + ifelse(onset <  time_inf_pos - exposure,
                                                                                                                       delayfn(nrow(prob_samples)),
                                                                                                                       ifelse(vect_isTRUE(vaccinated),
                                                                                                                              delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                                              delayfn_sympt(nrow(prob_samples)))),
                                                                       Inf)),
                                                         onset + ifelse(vect_isTRUE(first_test),
                                                                        0,
                                                                        ifelse(vect_isTRUE(autotest2),
                                                                               5,
                                                                               Inf)) + delayfn_vaccinated_sympt(nrow(prob_samples))#,
                                                  )
                                           )
    )]
    prob_samples$exit_test[prob_samples$isolated_time == Inf] <- NA
    
    # first exit test in a series of repeated exit tests
    prob_samples[, basic_exit_test := ifelse(vect_isTRUE(asym),
                                             NA,
                                             ifelse(vect_isTRUE(missed),
                                                    ifelse(vect_isTRUE(first_test),
                                                           onset + ifelse(vect_isTRUE(vaccinated),
                                                                          delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                          delayfn_sympt(nrow(prob_samples))) + X,
                                                           ifelse(vect_isTRUE(awareness_test),
                                                                  prob_samples$day_awareness_pos + onset + ifelse(vect_isTRUE(vaccinated),
                                                                                                                  delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                                  delayfn_sympt(nrow(prob_samples))) + X,
                                                                  NA)),
                                                    ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                           ifelse(vect_isTRUE(first_test),
                                                                  onset + ifelse(onset <  time_inf_pos - exposure,
                                                                                 delayfn(nrow(prob_samples)),
                                                                                 ifelse(vect_isTRUE(vaccinated),
                                                                                        delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                        delayfn_sympt(nrow(prob_samples)))) + X,
                                                                  ifelse(vect_isTRUE(awareness_test),
                                                                         prob_samples$day_awareness_pos + onset + ifelse(onset <  time_inf_pos - exposure,
                                                                                                                         delayfn(nrow(prob_samples)),
                                                                                                                         ifelse(vect_isTRUE(vaccinated),
                                                                                                                                delayfn_vaccinated_sympt(nrow(prob_samples)),
                                                                                                                                delayfn_sympt(nrow(prob_samples)))) + X,
                                                                         NA)),
                                                           onset + ifelse(vect_isTRUE(first_test),
                                                                          0,
                                                                          ifelse(vect_isTRUE(autotest2),
                                                                                 5,
                                                                                 NA)) + delayfn_vaccinated_sympt(nrow(prob_samples)) + X#,
                                                    )
                                             )
    )]
    prob_samples$basic_exit_test[prob_samples$isolated_time == Inf] <- NA
    
    # exit test
    Y <- 2
    max_number_tests <- floor((14 - 5)/Y+1)
    exit_test <- matrix(NA, nrow(prob_samples), max(max_number_tests))
    
    for (j in 1:nrow(prob_samples)){
      if (!is.na(prob_samples$basic_exit_test[j])){
        for(i in 1:max_number_tests){
          p <- sensitivity_individual(prob_samples$basic_exit_test[j] + (i-1)*Y - prob_samples$onset[j], prob_samples$t_1, prob_samples$t_2)
          exit_test[j, i] <- as.logical(purrr::rbernoulli(n = 1, p = p))
        }
      }
    }
    
    i_prime <- rep(0, nrow(prob_samples))
    for (j in 1:nrow(prob_samples)){
      i <- 1
      i_prime[j] <- -1
      while (i <= max_number_tests & i_prime[j] < 0){
        if(vect_isTRUE(!exit_test[j, i])){
          i_prime[j] <- i
        }
        i <- i + 1
      }
    }
    
    for (j in 1:nrow(prob_samples)){
      if (i_prime[j] != -1 & i_prime[j] != max_number_tests){
        for (i in (i_prime[j]+1):max_number_tests){
          exit_test[j, i] <- NA
        }
      }
    }
    number_exit_tests <- length(which(!is.na(exit_test)))
    ifelse(number_exit_tests != 0, 
           share_positive_exit_tests_belgium <- length(which(vect_isTRUE(exit_test)))/length(which(!is.na(exit_test))),
           share_positive_exit_tests_belgium <- 0
    )
    number_exit_tests
    
    prob_samples <- prob_samples[, time_exit_test := NA]
    prob_samples <- prob_samples[, exit_test := NA]
    for (j in 1:nrow(prob_samples)){
      flag <- NA
      day <- NA
      for (i in 1:max_number_tests){ 
        if(!is.na(exit_test[j, i])){
          day <- Inf
          flag <- TRUE
        }
      }
      for (i in 1:max_number_tests){ 
        if(vect_isTRUE(!exit_test[j,i])){
          flag <- FALSE
          day <- i
        }
      }
      prob_samples$exit_test[j] <- flag
      prob_samples$time_exit_test[j] <- (day-1)*Y + prob_samples$basic_exit_test[j]
    }
    
    prob_samples[, isolated_exit_time := ifelse(!is.na(exit_test),
                                                ifelse(vect_isTRUE(exit_test),
                                                       vect_max(ifelse(vect_isTRUE(asym),
                                                                       NA,
                                                                       ifelse(vect_isTRUE(missed),
                                                                              ifelse(vect_isTRUE(first_test),
                                                                                     onset,
                                                                                     ifelse(vect_isTRUE(awareness_test),
                                                                                            onset + day_awareness_pos,
                                                                                            NA)
                                                                              ),
                                                                              ifelse((onset < time_inf_pos - exposure & vect_isTRUE(adherence_sympt_traced)) | (onset > time_inf_pos - exposure & vect_isTRUE(!adherence_sympt_traced)),
                                                                                     ifelse(vect_isTRUE(first_test),
                                                                                            onset,
                                                                                            ifelse(vect_isTRUE(awareness_test),
                                                                                                   onset + day_awareness_pos,
                                                                                                   NA)
                                                                                     ),
                                                                                     ifelse(vect_isTRUE(first_test),
                                                                                            onset,
                                                                                            ifelse(vect_isTRUE(autotest2),
                                                                                                   onset + 5,
                                                                                                   NA))
                                                                              )
                                                                       )
                                                       ) + X + 9, isolated_time),
                                                       vect_max(time_exit_test + test_delay_antigenic, isolated_time) 
                                                ),
                                                NA)
    ]
    
    prob_samples$isolated_exit_time[prob_samples$isolated_exit_time == Inf] <- NA
    prob_samples[, c("basic_exit_test", "time_exit_test") := NULL]
    
  }
  
  # effect of isolation: with some probability an offspring is automatically removed
  prob_samples <- prob_samples[, removed:= ifelse(vect_isTRUE(prob_samples$infector_iso_time == Inf),
                                                  FALSE,
                                                  ifelse(vect_isTRUE(prob_samples$exposure > prob_samples$infector_iso_time & prob_samples$exposure < prob_samples$infector_iso_exit),
                                                         purrr::rbernoulli(n = 1, p = 1 - household_prob),
                                                         FALSE))]

  prob_samples <- prob_samples[!vect_isTRUE(prob_samples$removed)]
  # update the absolute times of exposure of the new generation
  prob_samples$timeexp <- prob_samples$exposure + prob_samples$infector_timeexp
  
  individual_tests <- ifelse(!is.na(prob_samples$first_test), 1, 0) + ifelse(!is.na(prob_samples$autotest1), 1, 0) + ifelse(!is.na(prob_samples$autotest2), 1, 0) + ifelse(!is.na(prob_samples$exit_test), 1, 0) + ifelse(!is.na(prob_samples$awareness_test), 1, 0)
  ll <- mean(prob_samples$time_inf_pos - prob_samples$exposure, na.rm = TRUE)
  number_tests <- nrow(prob_samples[!is.na(prob_samples$first_test)]) + nrow(prob_samples[!is.na(prob_samples$autotest1)]) + nrow(prob_samples[!is.na(prob_samples$autotest2)]) + ifelse(scenario == 3 | scenario == 4,
                                                                                                                                                                                         number_exit_tests,
                                                                                                                                                                                         nrow(prob_samples[!is.na(prob_samples$exit_test)])) + number_awareness_tests


  # records the isolation duration (detected cases only, i.e. those who tested positive to an entry test)
  a <- prob_samples$isolated_exit_time[vect_isTRUE(prob_samples$first_pos)] - prob_samples$isolated_time[vect_isTRUE(prob_samples$first_pos)]
  b <- mean(a)
  
  # Number of individuals who successfully isolate
  number_isolating <- length(which(prob_samples$isolated_time != Inf))
  
  # Number of individuals who are asymptomatic and isolate, as a consequence of being traced by their infector
  number_traced_asym_iso <- length(which(prob_samples$missed == FALSE & prob_samples$asym == TRUE & prob_samples$isolated_time != Inf))
  
  # Number of individuals who are symptomatic and isolate
  number_sympt_iso <- length(which(prob_samples$asym == FALSE & prob_samples$isolated_time != Inf))
  
  # Number of individuals who are vaccinated and isolate
  number_vacc_iso <- length(which(prob_samples$vaccinated == TRUE & prob_samples$isolated_time != Inf))
  
  infector_iso_time <- prob_samples$isolated_time
  infector_iso_exit <- prob_samples$isolated_exit_time
  t_1 <- prob_samples$t_1
  t_2 <- prob_samples$t_2
  prob_samples[, c("probability_full_iso", "test_compliance", "t_1","t_2","infector_missed", "infector_pos", "infector_iso_time", "infector_asym", "infector_iso_exit", "infector_timeexp", "adherence_sympt_traced", "autotest1", "autotest2", "exit_test", "time_inf_pos", "awareness_test", "day_awareness_pos", "X") := NULL]
  
  # Set new case ids for new people
  prob_samples$caseid <- (nrow(case_data) + 1):(nrow(case_data) + nrow(prob_samples))

  # Number of new cases in the new generation of infection
  cases_in_gen <- nrow(prob_samples)

  # estimate the effective reproduction number
  effective_r0 <- nrow(prob_samples[!vect_isTRUE(removed)]) / nrow(case_data[!vect_isTRUE(removed)])
  
  # each individual only gets one chance to infect
  case_data$removed <- TRUE
  
  # bind original cases + new secondary cases
  case_data <- data.table::rbindlist(list(case_data, prob_samples),
                                     use.names = TRUE)
  temporary <- 0
  
  # Return
  out <- list(case_data, effective_r0, cases_in_gen, case_data$new_cases, case_data$timeexp, number_tests, a, infector_iso_time, infector_iso_exit, number_isolating, number_traced_asym_iso, number_sympt_iso, number_vacc_iso, t_1, t_2, individual_tests, b)
  names(out) <- c("cases", "effective_r0", "cases_in_gen", "new_cases_ind", "timeexp", "number_tests", "mean_iso_duration", "infector_iso_time", "infector_iso_exit", "number_isolating", "number_traced_asym_iso", "number_sympt_iso", "number_vacc_iso", "individual_tests", "b")
  
  return(out)
}

